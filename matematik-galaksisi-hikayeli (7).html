<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;600;700&family=Russo+One&display=swap" rel="stylesheet">
    <title>Matematik Galaksisi: DoÄŸru MacerasÄ±</title>
    <link rel="stylesheet" href="style.css">

</head>
<body>
    <!-- YÄ±ldÄ±zlar Arka Plan -->
    <div class="stars" id="stars"></div>

    <!-- Ses Kontrol Paneli -->
    <div class="audio-panel-wrapper">
        <button class="music-control" id="musicControl" aria-expanded="false" aria-controls="audioPanel" aria-label="Ses panelini aÃ§/kapa">
            <span class="music-icon" aria-hidden="true">ğŸ”Š</span>
        </button>
        <div class="audio-panel" id="audioPanel" hidden>
            <div class="audio-panel-header">Ses AyarlarÄ±</div>
            <label class="audio-toggle">
                <input type="checkbox" id="musicToggle" checked>
                <span class="toggle-label">MÃ¼zik</span>
            </label>
            <label class="audio-toggle">
                <input type="checkbox" id="effectsToggle" checked>
                <span class="toggle-label">Efekt Sesleri</span>
            </label>
            <label class="audio-toggle">
                <input type="checkbox" id="speechToggle" checked>
                <span class="toggle-label">Hikaye AnlatÄ±mÄ±</span>
            </label>
            <label class="audio-toggle">
                <input type="checkbox" id="lowPerfToggle">
                <span class="toggle-label">Hafif Mod</span>
            </label>
        </div>
    </div>

    <!-- Ana Container -->
    <div class="container">
        <!-- GiriÅŸ EkranÄ± -->
        <div class="screen active" id="welcomeScreen">
            <div class="welcome-screen">
                <h1 class="game-title">ğŸš€ Matematik Galaksisi</h1>
                <p class="game-subtitle">DoÄŸru MacerasÄ±</p>

                <div class="hero-intro">
                    <p class="intro-kicker">Axel &amp; Orion galaksiyi kurtarmak iÃ§in yola Ã§Ä±ktÄ±.</p>
                    <p class="intro-lead">Bozulan yÄ±ldÄ±z rotalarÄ±, Ã§Ã¶ken <span class="math-term">analitik dÃ¼zlem</span> ve Kaos Lordu'nun tuzaklarÄ± arasÄ±nda ilerleyeceksin.</p>
                </div>

                <div class="collapsible-intro">
                    <button class="collapse-toggle" id="introToggle" aria-expanded="false">
                        Daha fazlasÄ±nÄ± oku â–¼
                    </button>
                    <div class="collapse-panel" id="longIntro" hidden>
                        <div class="character-intro">
                            <h2 class="character-name">ğŸ‘¨â€ğŸš€ Zeron - Galaktik KaÅŸif</h2>
                            <p class="character-desc">
                                Kaos Lordu galakside bÃ¼yÃ¼k bir karmaÅŸa yaratmÄ±ÅŸ durumda! YÄ±ldÄ±z haritalarÄ± bozulmuÅŸ,
                                koordinat sistemleri Ã§Ã¶kmÃ¼ÅŸ ve matematik dÃ¼zeni tamamen alt Ã¼st olmuÅŸ.
                                Axel, bu karmaÅŸayÄ± Ã§Ã¶zmek ve galaksiye dÃ¼zeni geri getirmek iÃ§in yola Ã§Ä±ktÄ±.
                            </p>
                        </div>

                        <div class="character-intro">
                            <h2 class="character-name">ğŸ¤– Orion - Hologram Asistan</h2>
                            <p class="character-desc">
                                Yapay zeka destekli hologram asistanÄ± Orion, Axel'in yanÄ±nda olacak.
                                Ancak gerÃ§ek gÃ¼cÃ¼ senden gelecek! 7 zorlu seviyeyi geÃ§erek Kaos Lordu'nu
                                yenmen ve galaksiyi kurtarman gerekiyor. Her seviyede 5 soru var ve zorluk
                                giderek artÄ±yor. SÃ¼re sÄ±nÄ±rÄ±n var, dikkatli ol!
                            </p>
                        </div>

                        <div class="character-intro character-intro-warning">
                            <h2 class="character-name">âš ï¸ GÃ¶rev KurallarÄ±</h2>
                            <p class="character-desc">
                                â€¢ Her seviyede 5 soru bulunur (Kolay â†’ Zor)<br>
                                â€¢ Her seviyenin kendine Ã¶zel sÃ¼re sÄ±nÄ±rÄ± var<br>
                                â€¢ SÃ¼re dolarsa seviye kapanÄ±r<br>
                                â€¢ Erken bitirene bonus puan verilir<br>
                                â€¢ Bir seviyeyi bitirmeden diÄŸerine geÃ§emezsin
                            </p>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="game.playSound('click'); game.showLevelSelect()">
                    Maceraya BaÅŸla! ğŸš€
                </button>
            </div>
        </div>

        <!-- Seviye SeÃ§im EkranÄ± -->
        <div class="screen" id="levelSelectScreen">
            <div class="level-select">
                <h1 class="game-title">Seviye SeÃ§</h1>
                <div class="levels-grid" id="levelsGrid"></div>
                <button class="btn btn-danger top-spacing" onclick="game.playSound('click'); game.showWelcome()">
                    Ana MenÃ¼
                </button>
            </div>
        </div>

        <!-- Oyun EkranÄ± -->
        <div class="screen" id="gameScreen">
            <div class="game-screen">
                <div class="game-header">
                    <div class="level-header">
                        <div class="level-info-game">
                            <h2 id="currentLevelTitle">Seviye 1</h2>
                            <p id="currentLevelDesc">AÃ§Ä±klama</p>
                        </div>
                        <div class="timer-container">
                            <div>â±ï¸ Kalan SÃ¼re</div>
                            <div class="timer" id="timer">3:00</div>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar-bg">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    </div>
                </div>

                <!-- Hikaye KartÄ± -->
                <div class="story-card" id="storyCard">
                    <div class="story-character" id="storyCharacter">ğŸ¤–</div>
                    <div class="story-title" id="storyTitle">Orion KonuÅŸuyor...</div>
                    <div class="story-text" id="storyText">HazÄ±rlanÄ±yor...</div>
                    <div class="story-actions">
                        <button class="btn btn-secondary" id="replayStoryBtn" onclick="game.playSound('click'); game.replayStory()" aria-live="polite">ğŸ” Tekrar Oku</button>
                    </div>
                </div>

                <div class="hint-bar" id="hintBar" aria-live="polite" hidden>
                    <button class="btn btn-warning hint-btn" onclick="game.playSound('click'); game.requestHint()">ğŸ’¡ Ä°pucu Al</button>
                </div>

                <div class="question-card" id="questionCard">
                    <div class="question-number" id="questionNumber">Soru 1/5</div>
                    <div class="question-meta" id="questionMeta" aria-live="polite"></div>
                    <div class="question-text" id="questionText">Soru yÃ¼kleniyor...</div>
                    <div class="answers-grid" id="answersGrid"></div>
                </div>

                <div class="explanation-box hidden" id="explanationBox" aria-live="polite"></div>
            </div>
        </div>

        <!-- SonuÃ§ EkranÄ± -->
        <div class="screen" id="resultScreen">
            <div class="result-screen">
                <div class="result-card">
                    <div class="result-icon" id="resultIcon">ğŸ‰</div>
                    <h2 class="result-title" id="resultTitle">Tebrikler!</h2>
                    <p id="resultMessage" class="result-message"></p>

                    <div class="result-badge" id="resultBadge" aria-live="polite"></div>

                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-label">DoÄŸru Cevap</div>
                            <div class="stat-value" id="correctAnswers">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">YanlÄ±ÅŸ Cevap</div>
                            <div class="stat-value" id="wrongAnswers">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">SÃ¼re Bonusu</div>
                            <div class="stat-value" id="timeBonus">+0</div>
                        </div>
                    </div>

                    <div class="bloom-summary hidden" id="bloomSummary" aria-live="polite"></div>

                    <div class="learning-summary hidden" id="learningSummary">
                        <h3>Bu seviyede neleri pekiÅŸtirdin?</h3>
                        <ul id="learningSummaryList"></ul>
                    </div>

                    <div class="result-actions">
                        <button class="btn btn-success" onclick="game.playSound('click'); game.nextLevel()">
                            Sonraki Seviye ğŸš€
                        </button>
                        <button class="btn btn-primary" onclick="game.playSound('click'); game.showLevelSelect()">
                            Seviye SeÃ§
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Final EkranÄ± -->
        <div class="screen" id="finalScreen">
            <div class="final-screen">
                <div class="result-card">
                    <div class="final-animation">ğŸ‘‘</div>
                    <h2 class="result-title">Galaksi KurtarÄ±ldÄ±!</h2>
                    <p class="final-message">
                        MuhteÅŸem bir iÅŸ Ã§Ä±kardÄ±n! TÃ¼m seviyeleri baÅŸarÄ±yla tamamladÄ±n ve 
                        Matematik Galaksisi'ne dÃ¼zeni geri getirdin. Axel ve Orion sana 
                        minnettarlar. Sen gerÃ§ek bir Matematik KahramanÄ±sÄ±n! ğŸŒŸ
                    </p>
                    
                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-label">Toplam Puan</div>
                            <div class="stat-value" id="finalScore">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">DoÄŸru Cevaplar</div>
                            <div class="stat-value" id="finalCorrect">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Tamamlanan Seviye</div>
                            <div class="stat-value">7/7</div>
                        </div>
                    </div>

                    <div class="final-theme-summary" id="finalThemeSummary"></div>

                    <button class="btn btn-primary" onclick="game.playSound('click'); game.restart()">
                        Yeniden Oyna ğŸ”„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Oyun Verileri - Hikaye OdaklÄ± Versiyon
        const gameData = {
            levels: [
                {
                    id: 1,
                    title: "KayÄ±p Koordinat HaritasÄ±",
                    description: "Axel, Kaos Lordu tarafÄ±ndan bozulan yÄ±ldÄ±z haritasÄ±nÄ± yeniden kurmak iÃ§in doÄŸru noktalarÄ± iÅŸaretlemek zorundadÄ±r. Orion'un hologram rehberliÄŸiyle harita yeniden aydÄ±nlatÄ±lacaktÄ±r.",
                    time: 180,
                    stories: [
                        {
                            character: "ğŸ¤–",
                            title: "Orion KonuÅŸuyor",
                            text: "Axel, yÄ±ldÄ±z haritasÄ± tamamen karÄ±ÅŸmÄ±ÅŸ! Koordinat sistemini yeniden kurmak iÃ§in pozitif bÃ¶lgedeki noktalarÄ± bulmalÄ±yÄ±z. Birinci kadran nerede?"
                        },
                        {
                            character: "ğŸ‘¨â€ğŸš€",
                            title: "Axel'in GÃ¶revi",
                            text: "AnladÄ±m Orion! Åimdi negatif y deÄŸerleri iÃ§eren noktalarÄ± bulmalÄ±yÄ±z. Bu noktalar dÃ¶rdÃ¼ncÃ¼ kadranda olmalÄ±, deÄŸil mi?"
                        },
                        {
                            character: "ğŸ¤–",
                            title: "Zorluk ArtÄ±yor",
                            text: "MÃ¼kemmel! Åimdi daha zorlu bir gÃ¶rev: Hem x hem de y deÄŸeri negatif olan noktalarÄ± bul. ÃœÃ§Ã¼ncÃ¼ kadran seni bekliyor!"
                        },
                        {
                            character: "âš¡",
                            title: "EÄŸim ÅeytanÄ± Beliriyor",
                            text: "Ha ha ha! Kesirli koordinatlar sizi durduracak! 2.5, 3.5 gibi deÄŸerler kafanÄ±zÄ± karÄ±ÅŸtÄ±racak!"
                        },
                        {
                            character: "ğŸ¤–",
                            title: "Final Testi",
                            text: "Son test Axel! Y ekseni Ã¼zerindeki Ã¶zel noktayÄ± bul. Sadece y deÄŸeri var, x=0 olmalÄ±. Koordinat sisteminin kalbine ulaÅŸtÄ±k!"
                        }
                    ],
                    questions: [
                        {
                            difficulty: "Kolay",
                            text: "Pozitif bÃ¶lgede basit bir nokta: Hangisi birinci bÃ¶lgede (x > 0, y > 0) yer alÄ±r?",
                            answers: ["(3, 4)", "(-3, 4)", "(3, -4)", "(-3, -4)"],
                            correct: 0,
                            topic: "kadran",
                            bloomLevel: "bilgi"
                        },
                        {
                            difficulty: "Kolay-Orta",
                            text: "Negatif y iÃ§eren nokta: Hangisi dÃ¶rdÃ¼ncÃ¼ bÃ¶lgede (x > 0, y < 0) yer alÄ±r?",
                            answers: ["(2, 3)", "(2, -3)", "(-2, -3)", "(-2, 3)"],
                            correct: 1,
                            topic: "kadran",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Orta",
                            text: "Hem negatif x hem negatif y: Hangisi Ã¼Ã§Ã¼ncÃ¼ bÃ¶lgede yer alÄ±r?",
                            answers: ["(5, 2)", "(-5, 2)", "(5, -2)", "(-5, -2)"],
                            correct: 3,
                            topic: "kadran",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Orta-Zor",
                            text: "Kesirli koordinatlar: Hangisi doÄŸru kesirli koordinattÄ±r?",
                            answers: ["(1.5, 2.5)", "(2, 3)", "(-1, -2)", "(0, 1)"],
                            correct: 0,
                            topic: "koordinat",
                            bloomLevel: "kavrama"
                        },
                        {
                            difficulty: "Zor",
                            text: "Orijin ve eksenlere gÃ¶re Ã¶zel nokta: Hangisi y ekseninin Ã¼zerinde yer alÄ±r?",
                            answers: ["(3, 0)", "(0, 3)", "(3, 3)", "(0, 0)"],
                            correct: 1,
                            topic: "orijin",
                            bloomLevel: "analiz"
                        }
                    ]
                },
                {
                    id: 2,
                    title: "EÄŸim DaÄŸlarÄ± GeÃ§idi",
                    description: "Axel, daÄŸ geÃ§itlerinden geÃ§ebilmek iÃ§in iki nokta arasÄ±ndaki eÄŸimi hesaplamak zorundadÄ±r. EÄŸim ÅŸeytanlarÄ± yanlÄ±ÅŸ hesaplamalarÄ± sever.",
                    time: 240,
                    stories: [
                        {
                            character: "â›°ï¸",
                            title: "DaÄŸ GeÃ§idinde",
                            text: "EÄŸim DaÄŸlarÄ± Ã¶nÃ¼nde duruyoruz. Ä°ki nokta arasÄ±ndaki eÄŸimi hesapla ki geÃ§ebilesin! Ä°lk geÃ§it: (1,2) ve (3,6). FormÃ¼l: (y2-y1)/(x2-x1)"
                        },
                        {
                            character: "ğŸ‘¹",
                            title: "EÄŸim ÅeytanÄ±",
                            text: "Pozitif eÄŸim kolaydÄ±! Ama negatif eÄŸimle baÅŸa Ã§Ä±kabilir misin? YukarÄ± Ã§Ä±kan yol mu, aÅŸaÄŸÄ± inen yol mu?"
                        },
                        {
                            character: "âš¡",
                            title: "Tehlikeli BÃ¶lge",
                            text: "Åimdi her iki koordinat da negatif! (-2,-3) ve (2,5) arasÄ± ne kadar dik? Kafan karÄ±ÅŸacak!"
                        },
                        {
                            character: "ğŸ¤–",
                            title: "Orion UyarÄ±yor",
                            text: "Dikkat Axel! Kesirli eÄŸimler yaklaÅŸÄ±yor. 3/4 gibi deÄŸerler seni ÅŸaÅŸÄ±rtabilir. Dikkatli hesapla!"
                        },
                        {
                            character: "ğŸ‘¹",
                            title: "Son Tuzak",
                            text: "Ha ha! X deÄŸerleri aynÄ± olan noktalar! EÄŸim tanÄ±msÄ±z mÄ±, yoksa 0 mÄ±? DÃ¼ÅŸey Ã§izgi seni bekliyor!"
                        }
                    ],
                    questions: [
                        {
                            difficulty: "Kolay",
                            text: "Pozitif eÄŸimli tam sayÄ± noktalarÄ±: (1, 2) ve (3, 6) noktalarÄ± arasÄ±ndaki eÄŸim kaÃ§tÄ±r?",
                            answers: ["1", "2", "3", "4"],
                            correct: 1,
                            topic: "egim",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Kolay-Orta",
                            text: "Negatif eÄŸimli iki nokta: (1, 5) ve (3, 1) noktalarÄ± arasÄ±ndaki eÄŸim kaÃ§tÄ±r?",
                            answers: ["2", "-2", "1/2", "-1/2"],
                            correct: 1,
                            topic: "egim",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Orta",
                            text: "Ters iÅŸaretli x-y deÄŸerleri: (-2, -3) ve (2, 5) noktalarÄ±nÄ±n eÄŸimi?",
                            answers: ["1", "2", "3", "4"],
                            correct: 1,
                            topic: "egim",
                            bloomLevel: "kavrama"
                        },
                        {
                            difficulty: "Orta-Zor",
                            text: "Kesirli eÄŸim oluÅŸturacak uzak noktalar: (1, 2) ve (5, 5) arasÄ±ndaki eÄŸim?",
                            answers: ["1/2", "3/4", "2/3", "4/3"],
                            correct: 1,
                            topic: "egim",
                            bloomLevel: "analiz"
                        },
                        {
                            difficulty: "Zor",
                            text: "EÄŸim tanÄ±msÄ±z mÄ±? (3, 2) ve (3, 7) noktalarÄ± iÃ§in eÄŸim nedir?",
                            answers: ["0", "5", "TanÄ±msÄ±z", "-5"],
                            correct: 2,
                            topic: "egim",
                            bloomLevel: "bilgi"
                        }
                    ]
                },
                {
                    id: 3,
                    title: "AÃ§Ä± TÃ¼nelleri Labirenti",
                    description: "Axel, antik tÃ¼nellerde doÄŸru eÄŸimi seÃ§erek ilerlemelidir. YanlÄ±ÅŸ aÃ§Ä±, Ã§Ä±kmaza gÃ¶tÃ¼rÃ¼r.",
                    time: 240,
                    stories: [
                        {
                            character: "ğŸ›ï¸",
                            title: "TÃ¼nel GiriÅŸi",
                            text: "Antik tÃ¼nellere hoÅŸ geldin! Her tÃ¼nelin bir aÃ§Ä±sÄ± var. 45Â° aÃ§Ä± en dengeli yol... eÄŸimi 1'dir!"
                        },
                        {
                            character: "ğŸ¤–",
                            title: "Ã–zel Durumlar",
                            text: "Axel dikkat! Yatay tÃ¼nel (0Â°) ve dikey tÃ¼nel (90Â°). Biri eÄŸim 0, diÄŸeri tanÄ±msÄ±z!"
                        },
                        {
                            character: "ğŸ“",
                            title: "Trigonometri ZamanÄ±",
                            text: "30Â° aÃ§Ä±sÄ± seni bekliyor! tan(30Â°) = âˆš3/3 â‰ˆ 0.577. Hafif eÄŸimli bir yol..."
                        },
                        {
                            character: "â›°ï¸",
                            title: "Dik TÄ±rmanÄ±ÅŸ",
                            text: "60Â° Ã§ok dik! tan(60Â°) = âˆš3 â‰ˆ 1.732. Zorlu bir tÄ±rmanÄ±ÅŸ seni bekliyor!"
                        },
                        {
                            character: "ğŸŒ€",
                            title: "Ters DÃ¼nya",
                            text: "Negatif aÃ§Ä±! X ekseninin altÄ±na iniyoruz. -45Â° iÃ§in eÄŸim -1. AÅŸaÄŸÄ± doÄŸru gidiyoruz!"
                        }
                    ],
                    questions: [
                        {
                            difficulty: "Kolay",
                            text: "45Â° aÃ§Ä±sÄ±nÄ±n eÄŸimi kaÃ§tÄ±r?",
                            answers: ["0", "1", "âˆš3", "TanÄ±msÄ±z"],
                            correct: 1,
                            topic: "trigonometrik_egim",
                            bloomLevel: "bilgi"
                        },
                        {
                            difficulty: "Kolay-Orta",
                            text: "0Â° ve 90Â° Ã¶zel durumlar: 0Â° aÃ§Ä±sÄ±nÄ±n (yatay doÄŸru) eÄŸimi nedir?",
                            answers: ["0", "1", "âˆ", "TanÄ±msÄ±z"],
                            correct: 0,
                            topic: "trigonometrik_egim",
                            bloomLevel: "kavrama"
                        },
                        {
                            difficulty: "Orta",
                            text: "30Â° aÃ§Ä±sÄ±nÄ±n eÄŸimi hangisidir? (tan 30Â° = âˆš3/3 â‰ˆ 0.577)",
                            answers: ["0.5", "âˆš3/3", "1", "âˆš3"],
                            correct: 1,
                            topic: "trigonometrik_egim",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Orta-Zor",
                            text: "60Â° aÃ§Ä±sÄ±nÄ±n eÄŸimi hangisidir? (tan 60Â° = âˆš3 â‰ˆ 1.732)",
                            answers: ["1", "âˆš3/3", "âˆš3", "2"],
                            correct: 2,
                            topic: "trigonometrik_egim",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Zor",
                            text: "Negatif aÃ§Ä±nÄ±n eÄŸimi: -45Â° aÃ§Ä±sÄ± (x ekseninin altÄ±nda) hangi eÄŸime sahiptir?",
                            answers: ["1", "-1", "0", "TanÄ±msÄ±z"],
                            correct: 1,
                            topic: "trigonometrik_egim",
                            bloomLevel: "analiz"
                        }
                    ]
                },
                {
                    id: 4,
                    title: "Denklem TapÄ±naÄŸÄ±",
                    description: "Antik tapÄ±nak kapÄ±larÄ± yalnÄ±zca doÄŸru eÄŸim ve noktadan doÄŸru b deÄŸerini bulunca aÃ§Ä±lÄ±r.",
                    time: 300,
                    stories: [
                        {
                            character: "ğŸ›ï¸",
                            title: "TapÄ±nak KapÄ±sÄ±",
                            text: "y = mx + b... Ezberinde olan formÃ¼l! DoÄŸru y eksenini kestiÄŸi noktada b deÄŸeri okunur. (0,b) noktasÄ± ÅŸifre!"
                        },
                        {
                            character: "ğŸ“œ",
                            title: "Ä°lk Åifre",
                            text: "EÄŸim 3, nokta (1,7). y = 3x + b formÃ¼lÃ¼nde 7 = 3(1) + b... b = 4! KapÄ± aralanÄ±yor..."
                        },
                        {
                            character: "âš¡",
                            title: "Negatif GÃ¼Ã§ler",
                            text: "Negatif eÄŸimler tapÄ±naÄŸÄ± koruyor! m = -2, nokta (3,4). Hesapla: 4 = -2(3) + b âŸ¹ b = 10"
                        },
                        {
                            character: "ğŸŒ€",
                            title: "Kesirli BÃ¼yÃ¼",
                            text: "Kesirli eÄŸim! m = 1/2, nokta (4,5). Denklem: 5 = (1/2)(4) + b âŸ¹ 5 = 2 + b âŸ¹ b = 3"
                        },
                        {
                            character: "ğŸ‘‘",
                            title: "Son KapÄ±",
                            text: "Final ÅŸifresi! Denklemi Ã§Ã¶z: y = -3x + b, nokta (2,1). 1 = -3(2) + b âŸ¹ b = 7. TapÄ±nak aÃ§Ä±lÄ±yor!"
                        }
                    ],
                    questions: [
                        {
                            difficulty: "Kolay",
                            text: "Nokta (0, b) iÃ§eren Ã¶rnek: y = mx + b denkleminde, doÄŸru (0, 5) noktasÄ±ndan geÃ§iyorsa b kaÃ§tÄ±r?",
                            answers: ["0", "5", "m", "x"],
                            correct: 1,
                            topic: "dogru_denklemi",
                            bloomLevel: "bilgi"
                        },
                        {
                            difficulty: "Kolay-Orta",
                            text: "Tam sayÄ±lÄ± eÄŸim ve nokta: EÄŸimi 3 olan ve (1, 7) noktasÄ±ndan geÃ§en doÄŸru iÃ§in b?",
                            answers: ["3", "4", "7", "10"],
                            correct: 1,
                            topic: "dogru_denklemi",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Orta",
                            text: "Negatif eÄŸim + tam sayÄ± nokta: EÄŸimi -2 olan ve (3, 4) noktasÄ±ndan geÃ§en doÄŸru iÃ§in b?",
                            answers: ["6", "8", "10", "12"],
                            correct: 2,
                            topic: "dogru_denklemi",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Orta-Zor",
                            text: "Kesirli eÄŸim + tam sayÄ± nokta: EÄŸimi 1/2 olan ve (4, 5) noktasÄ±ndan geÃ§en doÄŸru iÃ§in b?",
                            answers: ["1", "2", "3", "4"],
                            correct: 2,
                            topic: "dogru_denklemi",
                            bloomLevel: "kavrama"
                        },
                        {
                            difficulty: "Zor",
                            text: "Denklemi b'ye gÃ¶re Ã§Ã¶zme: y = -3x + b denklemi (2, 1) noktasÄ±ndan geÃ§iyorsa b kaÃ§tÄ±r?",
                            answers: ["5", "6", "7", "8"],
                            correct: 2,
                            topic: "dogru_denklemi",
                            bloomLevel: "analiz"
                        }
                    ]
                },
                {
                    id: 5,
                    title: "Paralel KÃ¶prÃ¼ler",
                    description: "Axel, uzay uÃ§urumundaki kÃ¶prÃ¼lerin paralel, kesiÅŸen veya Ã§akÄ±ÅŸÄ±k olduÄŸunu belirlemek zorundadÄ±r.",
                    time: 300,
                    stories: [
                        {
                            character: "ğŸŒ‰",
                            title: "KÃ¶prÃ¼ Sistemi",
                            text: "Ä°ki kÃ¶prÃ¼ gÃ¶r! EÄŸimleri aynÄ± ama farklÄ± yerlerde: y = 3x + 2 ve y = 3x - 5. Paralel! HiÃ§ kesiÅŸmezler!"
                        },
                        {
                            character: "âš”ï¸",
                            title: "Ã‡arpÄ±ÅŸma!",
                            text: "FarklÄ± eÄŸimler: y = 2x + 1 ve y = -x + 4. Bu kÃ¶prÃ¼ler bir noktada kesiÅŸiyor! Dikkat et!"
                        },
                        {
                            character: "ğŸ‘¯",
                            title: "Ä°kiz KÃ¶prÃ¼ler",
                            text: "y = 4x + 2 ve 2y = 8x + 4... Ä°kincisini sadeleÅŸtir: y = 4x + 2. AynÄ± doÄŸru! Ã‡akÄ±ÅŸÄ±k!"
                        },
                        {
                            character: "ğŸ§®",
                            title: "Gizli Format",
                            text: "2y = 6x + 4 basitleÅŸtir: y = 3x + 2. DiÄŸeri y = 3x - 1. AynÄ± eÄŸim, farklÄ± b... Paralel!"
                        },
                        {
                            character: "ğŸ¯",
                            title: "Son Test",
                            text: "3y = 9x + 6 âŸ¹ y = 3x + 2. DiÄŸeri y = 3x + 2. Hem eÄŸim hem b aynÄ±! Ã‡akÄ±ÅŸÄ±k doÄŸrular!"
                        }
                    ],
                    questions: [
                        {
                            difficulty: "Kolay",
                            text: "AynÄ± eÄŸim â€“ farklÄ± b (paralel): y = 3x + 2 ve y = 3x - 5 doÄŸrularÄ±?",
                            answers: ["Paralel", "KesiÅŸir", "Ã‡akÄ±ÅŸÄ±k", "Dik"],
                            correct: 0,
                            topic: "paralellik",
                            bloomLevel: "bilgi"
                        },
                        {
                            difficulty: "Kolay-Orta",
                            text: "FarklÄ± eÄŸim â€“ kesiÅŸir: y = 2x + 1 ve y = -x + 4 doÄŸrularÄ±?",
                            answers: ["Paralel", "KesiÅŸir", "Ã‡akÄ±ÅŸÄ±k", "Dik"],
                            correct: 1,
                            topic: "paralellik",
                            bloomLevel: "kavrama"
                        },
                        {
                            difficulty: "Orta",
                            text: "AynÄ± doÄŸru â€“ Ã§akÄ±ÅŸÄ±k: y = 4x + 2 ve 2y = 8x + 4 doÄŸrularÄ±?",
                            answers: ["Paralel", "KesiÅŸir", "Ã‡akÄ±ÅŸÄ±k", "Dik"],
                            correct: 2,
                            topic: "paralellik",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Orta-Zor",
                            text: "EÄŸim bulmayÄ± gerektiren: 2y = 6x + 4 ve y = 3x - 1 doÄŸrularÄ±?",
                            answers: ["Paralel", "KesiÅŸir", "Ã‡akÄ±ÅŸÄ±k", "Dik"],
                            correct: 0,
                            topic: "paralellik",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Zor",
                            text: "EÄŸim ve b karÅŸÄ±laÅŸtÄ±rmasÄ±: 3y = 9x + 6 ve y = 3x + 2 doÄŸrularÄ±?",
                            answers: ["Paralel", "KesiÅŸir", "Ã‡akÄ±ÅŸÄ±k", "Dik"],
                            correct: 2,
                            topic: "paralellik",
                            bloomLevel: "analiz"
                        }
                    ]
                },
                {
                    id: 6,
                    title: "Dik KesiÅŸim SavaÅŸ AlanÄ±",
                    description: "Savunma hatlarÄ±nÄ± kurmak iÃ§in Axel dik doÄŸrularÄ±n eÄŸim iliÅŸkisini Ã§Ã¶zmelidir.",
                    time: 240,
                    stories: [
                        {
                            character: "âš”ï¸",
                            title: "Savunma HattÄ±",
                            text: "Dik doÄŸrular: eÄŸimleri Ã§arpÄ±mÄ± -1! m = 2 ise dik olanÄ±n eÄŸimi -1/2. Matematiksel sihir!"
                        },
                        {
                            character: "ğŸ›¡ï¸",
                            title: "Negatif Kalkan",
                            text: "m = -4 iÃ§in dik eÄŸim? FormÃ¼l: mâ‚ Ã— mâ‚‚ = -1 âŸ¹ (-4) Ã— mâ‚‚ = -1 âŸ¹ mâ‚‚ = 1/4"
                        },
                        {
                            character: "âš¡",
                            title: "Kesirli SaldÄ±rÄ±",
                            text: "m = 3/4 iÃ§in dik? (3/4) Ã— mâ‚‚ = -1 âŸ¹ mâ‚‚ = -4/3. Ters Ã§evir ve negatif yap!"
                        },
                        {
                            character: "ğŸŒ€",
                            title: "Yatay-Dikey",
                            text: "Yatay doÄŸru (m=0) iÃ§in dik eÄŸim tanÄ±msÄ±z! DÃ¼ÅŸey Ã§izgi (x=k) yataya diktir!"
                        },
                        {
                            character: "ğŸ‘‘",
                            title: "Son Savunma",
                            text: "x = 3 dÃ¼ÅŸey doÄŸrusuna dik olan? Yatay doÄŸru! y = k ÅŸeklinde. 90Â° dÃ¶nÃ¼ÅŸ!"
                        }
                    ],
                    questions: [
                        {
                            difficulty: "Kolay",
                            text: "m=2 iÃ§in dik eÄŸim: EÄŸimi 2 olan doÄŸruya dik olan doÄŸrunun eÄŸimi?",
                            answers: ["2", "-2", "1/2", "-1/2"],
                            correct: 3,
                            topic: "diklik",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Kolay-Orta",
                            text: "Negatif m iÃ§in dik eÄŸim: EÄŸimi -4 olan doÄŸruya dik doÄŸrunun eÄŸimi?",
                            answers: ["4", "-4", "1/4", "-1/4"],
                            correct: 2,
                            topic: "diklik",
                            bloomLevel: "kavrama"
                        },
                        {
                            difficulty: "Orta",
                            text: "Kesirli eÄŸimde dik eÄŸim: EÄŸimi 3/4 olan doÄŸruya dik doÄŸrunun eÄŸimi?",
                            answers: ["3/4", "-3/4", "4/3", "-4/3"],
                            correct: 3,
                            topic: "diklik",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Orta-Zor",
                            text: "0 eÄŸime dik eÄŸim: Yatay doÄŸruya (m = 0) dik olan doÄŸrunun eÄŸimi?",
                            answers: ["0", "1", "TanÄ±msÄ±z", "-1"],
                            correct: 2,
                            topic: "diklik",
                            bloomLevel: "bilgi"
                        },
                        {
                            difficulty: "Zor",
                            text: "x=k doÄŸrularla diklik: x = 3 ÅŸeklindeki dÃ¼ÅŸey doÄŸruya dik olan doÄŸru nasÄ±ldÄ±r?",
                            answers: ["DÃ¼ÅŸey (x=k)", "Yatay (y=k)", "EÄŸik", "Olamaz"],
                            correct: 1,
                            topic: "diklik",
                            bloomLevel: "analiz"
                        }
                    ]
                },
                {
                    id: 7,
                    title: "GerÃ§eklik Ä°stasyonu",
                    description: "Axel, doÄŸrusal grafikleri okuyarak Kaos Lordu'nun son ilÃ¼zyonlarÄ±nÄ± yok edecektir.",
                    time: 360,
                    stories: [
                        {
                            character: "ğŸš—",
                            title: "GerÃ§ek DÃ¼nya",
                            text: "AraÃ§ 50 km/saat hÄ±zla gidiyor. 4 saat sonra? y = 50x formÃ¼lÃ¼! x=4 âŸ¹ y = 200 km!"
                        },
                        {
                            character: "ğŸ’§",
                            title: "Azalan Kaynak",
                            text: "120 litre su, saatte 15 litre azalÄ±yor. 4 saat sonra? y = 120 - 15x âŸ¹ y = 60 litre!"
                        },
                        {
                            character: "ğŸ“Š",
                            title: "Grafik Okuma",
                            text: "(0,0)'dan (5,15)'e doÄŸru Ã§izen. EÄŸim = 15/5 = 3. Grafikte eÄŸim = diklik!"
                        },
                        {
                            character: "âš–ï¸",
                            title: "KarÅŸÄ±laÅŸtÄ±rma",
                            text: "y = 2x ve y = 5x... Hangisi daha dik? EÄŸim bÃ¼yÃ¼k olan! 5 > 2, yani y = 5x!"
                        },
                        {
                            character: "ğŸ‘‘",
                            title: "Kaos Lordu'nun Sonu",
                            text: "(0,10)'dan baÅŸlÄ±yor, eÄŸim 6. x=3 iÃ§in? y = 6(3) + 10 = 28! Galaksi kurtuldu!"
                        }
                    ],
                    questions: [
                        {
                            difficulty: "Kolay",
                            text: "y=mx grafiÄŸinde zaman-yol: Bir araÃ§ 50 km/saat hÄ±zla gidiyor. 4 saatte kaÃ§ km yol alÄ±r? (y = 50x)",
                            answers: ["150 km", "200 km", "250 km", "300 km"],
                            correct: 1,
                            topic: "hiz_orani",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Kolay-Orta",
                            text: "Azalan doÄŸru: Bir depo 120 litre suyla dolu ve saatte 15 litre boÅŸalÄ±yor. 4 saat sonra kaÃ§ litre kalÄ±r? (y = 120 - 15x)",
                            answers: ["50", "60", "70", "80"],
                            correct: 1,
                            topic: "hiz_orani",
                            bloomLevel: "uygulama"
                        },
                        {
                            difficulty: "Orta",
                            text: "Grafikten eÄŸim okuma: Bir doÄŸru (0, 0) ve (5, 15) noktalarÄ±ndan geÃ§iyor. EÄŸimi kaÃ§tÄ±r?",
                            answers: ["2", "3", "4", "5"],
                            correct: 1,
                            topic: "grafik",
                            bloomLevel: "bilgi"
                        },
                        {
                            difficulty: "Orta-Zor",
                            text: "Ä°ki grafiÄŸi karÅŸÄ±laÅŸtÄ±rma: y = 2x ve y = 5x grafiklerinden hangisi daha diktir?",
                            answers: ["y = 2x", "y = 5x", "Ä°kisi eÅŸit", "Belirlenemez"],
                            correct: 1,
                            topic: "grafik",
                            bloomLevel: "analiz"
                        },
                        {
                            difficulty: "Zor",
                            text: "Grafikten hÄ±z Ã§Ä±karma: Grafik (0, 10) noktasÄ±ndan baÅŸlÄ±yor ve eÄŸimi 6. x = 3 iÃ§in y deÄŸeri kaÃ§tÄ±r?",
                            answers: ["24", "26", "28", "30"],
                            correct: 2,
                            topic: "hiz_orani",
                            bloomLevel: "kavrama"
                        }
                    ]
                }
            ]
        };

        const levelThemes = {
            1: { name: "EÄŸim Galaksisi", primaryColor: "#38bdf8", secondaryColor: "#0f172a", icon: "ğŸ“ˆ", backgroundClass: "theme-slope" },
            2: { name: "Koordinat SektÃ¶rÃ¼", primaryColor: "#22c55e", secondaryColor: "#0c1725", icon: "ğŸ§­", backgroundClass: "theme-quadrant" },
            3: { name: "AÃ§Ä± TÃ¼nelleri", primaryColor: "#a855f7", secondaryColor: "#1a0b2e", icon: "ğŸ“", backgroundClass: "theme-angle" },
            4: { name: "Paralel Koridor", primaryColor: "#f59e0b", secondaryColor: "#1c1305", icon: "âš¡", backgroundClass: "theme-parallel" },
            5: { name: "Kesim KÃ¶prÃ¼sÃ¼", primaryColor: "#22d3ee", secondaryColor: "#07131c", icon: "ğŸŒ‰", backgroundClass: "theme-intersect" },
            6: { name: "Analitik YÃ¶rÃ¼nge", primaryColor: "#ef4444", secondaryColor: "#1a0a0a", icon: "ğŸ›°", backgroundClass: "theme-orbit" },
            7: { name: "GerÃ§eklik Ã‡ekirdeÄŸi", primaryColor: "#14b8a6", secondaryColor: "#041b14", icon: "ğŸŒŒ", backgroundClass: "theme-core" }
        };

        const questionMeta = {
            1: [
                {
                    topic: 'kadran',
                    bloomLevel: 'bilgi',
                    tags: ['kadran', 'koordinat sistemi'],
                    explanation: {
                        correct: 'Birinci kadranda hem x hem y deÄŸeri pozitiftir; iki iÅŸaretin de + olmasÄ± doÄŸru noktayÄ± gÃ¶sterir.',
                        wrong: 'Kadran belirlerken x ve y iÅŸaretlerine birlikte bak; pozitif/pozitif kombinasyonu seni doÄŸru yere gÃ¶tÃ¼rÃ¼r.'
                    }
                },
                {
                    topic: 'kadran',
                    bloomLevel: 'uygulama',
                    tags: ['kadran', 'negatif y'],
                    explanation: {
                        correct: 'DÃ¶rdÃ¼ncÃ¼ kadranda x pozitiftir, y negatiftir; oklar aÅŸaÄŸÄ± doÄŸruya yÃ¶nelir.',
                        wrong: 'Bir dahaki denemede dÃ¶rdÃ¼ncÃ¼ kadran iÃ§in xâ€™in +, yâ€™nin - olmasÄ± gerektiÄŸini hatÄ±rla.'
                    }
                },
                {
                    topic: 'kadran',
                    bloomLevel: 'uygulama',
                    tags: ['kadran', 'negatif'],
                    explanation: {
                        correct: 'ÃœÃ§Ã¼ncÃ¼ kadranda her iki deÄŸer de negatiftir; (-x, -y) noktalarÄ± burada yaÅŸar.',
                        wrong: 'ÃœÃ§Ã¼ncÃ¼ kadran iÃ§in hem x hem y iÅŸaretlerinin - olmasÄ± gerektiÄŸini gÃ¶zden kaÃ§Ä±rdÄ±n.'
                    }
                },
                {
                    topic: 'koordinat',
                    bloomLevel: 'kavrama',
                    tags: ['kesirli', 'kadran'],
                    explanation: {
                        correct: 'Kesirli koordinatlar da aynÄ± kuralÄ± izler: x ve yâ€™nin iÅŸaretine gÃ¶re kadran belirlenir.',
                        wrong: 'Ä°ÅŸaret kontrolÃ¼ kesirli deÄŸerlerde de geÃ§erli; basamaklara deÄŸil, +/âˆ’ iÅŸaretine odaklan.'
                    }
                },
                {
                    topic: 'orijin',
                    bloomLevel: 'analiz',
                    tags: ['y ekseni', 'orijin'],
                    explanation: {
                        correct: 'Y ekseni Ã¼zerindeki noktalarÄ±n x deÄŸeri 0â€™dÄ±r; (0, y) formunu aradÄ±n ve buldun.',
                        wrong: 'Eksen sorularÄ±nda hangi deÄŸiÅŸkenin 0 olduÄŸuna bak; y ekseninde x=0 olmalÄ±.'
                    }
                }
            ],
            2: [
                {
                    topic: 'egim',
                    bloomLevel: 'uygulama',
                    tags: ['eÄŸim', 'oran'],
                    explanation: {
                        correct: 'EÄŸim, y deÄŸiÅŸiminin x deÄŸiÅŸimine oranÄ±dÄ±r; (y2âˆ’y1)/(x2âˆ’x1) ile pozitif artÄ±ÅŸÄ± okudun.',
                        wrong: 'Ä°ki nokta arasÄ±ndaki artÄ±ÅŸ/azalÄ±ÅŸ oranÄ±nÄ± bÃ¶lmeyi unutma; y farkÄ±nÄ± x farkÄ±na bÃ¶lmek yeterli.'
                    }
                },
                {
                    topic: 'egim',
                    bloomLevel: 'uygulama',
                    tags: ['eÄŸim', 'negatif eÄŸim'],
                    explanation: {
                        correct: 'YukarÄ±dan aÅŸaÄŸÄ±ya inen doÄŸrularda y azalÄ±r; oran negatif olur ve bu seÃ§imi yaptÄ±n.',
                        wrong: 'Azalan doÄŸrularda y farkÄ± negatif Ã§Ä±kar; payÄ±n iÅŸaretini kontrol etmek sonuca gÃ¶tÃ¼rÃ¼r.'
                    }
                },
                {
                    topic: 'egim',
                    bloomLevel: 'kavrama',
                    tags: ['eÄŸim', 'karÄ±ÅŸÄ±k iÅŸaret'],
                    explanation: {
                        correct: 'Ä°ÅŸaretler karÄ±ÅŸÄ±k olsa da formÃ¼l aynÄ±; y farkÄ±nÄ± x farkÄ±na bÃ¶ldÃ¼ÄŸÃ¼nde eÄŸimi yakaladÄ±n.',
                        wrong: 'FarklarÄ±n iÅŸaretini ayrÄ± ayrÄ± dÃ¼ÅŸÃ¼n; oranÄ± hesaplarken pay ve payda iÅŸaretleri sonucu belirler.'
                    }
                },
                {
                    topic: 'egim',
                    bloomLevel: 'analiz',
                    tags: ['eÄŸim', 'kesir'],
                    explanation: {
                        correct: 'Farklar kÃ¼Ã§Ã¼k olsa da eÄŸim yine bÃ¶lme ile bulunur; kesirli deÄŸeri doÄŸru okudun.',
                        wrong: 'Kesirli eÄŸimlerde de aynÄ± formÃ¼l geÃ§erli; pay/payda oranÄ±nÄ± sadeleÅŸtirerek ilerle.'
                    }
                },
                {
                    topic: 'egim',
                    bloomLevel: 'bilgi',
                    tags: ['tanÄ±msÄ±z', 'dikey doÄŸru'],
                    explanation: {
                        correct: 'x farkÄ± 0 olduÄŸunda dikey doÄŸru oluÅŸur ve eÄŸim tanÄ±msÄ±zdÄ±r; payda olmadÄ±ÄŸÄ± iÃ§in sonuÃ§ olmaz.',
                        wrong: 'Dikey doÄŸrularda x farkÄ± 0 olduÄŸu iÃ§in bÃ¶lme yapÄ±lamaz; bu durumda eÄŸim tanÄ±msÄ±zdÄ±r.'
                    }
                }
            ],
            3: [
                {
                    topic: 'trigonometrik_egim',
                    bloomLevel: 'bilgi',
                    tags: ['aÃ§Ä±', 'eÄŸim'],
                    explanation: {
                        correct: '45Â° iÃ§in tan Î¸ = 1â€™dir; eÄŸim 1 olduÄŸunda doÄŸru kÃ¶ÅŸegen olur.',
                        wrong: '45Â° aÃ§Ä±larÄ± iÃ§in eÄŸim 1â€™e eÅŸittir; tan 45Â° bilgisini hatÄ±rlamak iÅŸini kolaylaÅŸtÄ±rÄ±r.'
                    }
                },
                {
                    topic: 'trigonometrik_egim',
                    bloomLevel: 'kavrama',
                    tags: ['yatay doÄŸru', 'aÃ§Ä±'],
                    explanation: {
                        correct: '0Â°â€™lik yatay doÄŸrunun eÄŸimi 0â€™dÄ±r; y deÄŸiÅŸimi olmadÄ±ÄŸÄ±ndan oran sÄ±fÄ±r olur.',
                        wrong: 'Yatay doÄŸruda y deÄŸiÅŸimi yok; tan 0Â° = 0 bilgisini kullanarak eÄŸimin sÄ±fÄ±r olduÄŸunu hatÄ±rla.'
                    }
                },
                {
                    topic: 'trigonometrik_egim',
                    bloomLevel: 'uygulama',
                    tags: ['trigonometri', 'kesirli eÄŸim'],
                    explanation: {
                        correct: '30Â°â€™nin tan deÄŸeri âˆš3/3â€™tÃ¼r; hafif eÄŸimli yolu doÄŸru yorumladÄ±n.',
                        wrong: '30Â° aÃ§Ä± iÃ§in tan deÄŸeri kÃ¼Ã§Ã¼k ve pozitif; yaklaÅŸÄ±k 0.577 deÄŸerini hatÄ±rlamak yardÄ±mcÄ± olur.'
                    }
                },
                {
                    topic: 'trigonometrik_egim',
                    bloomLevel: 'uygulama',
                    tags: ['trigonometri', 'dik eÄŸim'],
                    explanation: {
                        correct: '60Â° tan deÄŸeri âˆš3â€™tÃ¼r; eÄŸimin bÃ¼yÃ¼mesi doÄŸrunun dikleÅŸtiÄŸini gÃ¶sterir.',
                        wrong: '60Â°â€™de tan deÄŸeri 1â€™den bÃ¼yÃ¼ktÃ¼r; dikleÅŸen doÄŸrular iÃ§in bÃ¼yÃ¼k eÄŸim bekle.'
                    }
                },
                {
                    topic: 'trigonometrik_egim',
                    bloomLevel: 'analiz',
                    tags: ['aÃ§Ä±', 'negatif eÄŸim'],
                    explanation: {
                        correct: '-45Â° iÃ§in tan deÄŸerinin -1 olmasÄ±, doÄŸruyun aÅŸaÄŸÄ± doÄŸru gittiÄŸini anlatÄ±r.',
                        wrong: 'Negatif aÃ§Ä±larda eÄŸim de negatiftir; -45Â° iÃ§in tan deÄŸeri -1â€™dir, iÅŸaret kontrolÃ¼ yeterli.'
                    }
                }
            ],
            4: [
                {
                    topic: 'dogru_denklemi',
                    bloomLevel: 'bilgi',
                    tags: ['doÄŸru denklemi', 'y ekseni'],
                    explanation: {
                        correct: 'y = mx + b denkleminde (0,b) noktasÄ± doÄŸrunun y eksenini kestiÄŸi yerdir; b doÄŸrudan okunur.',
                        wrong: 'Eksen kesiÅŸiminde x=0 olur; bu durumda y deÄŸeri bâ€™ye eÅŸittir, bu ipucunu kullanabilirsin.'
                    }
                },
                {
                    topic: 'dogru_denklemi',
                    bloomLevel: 'uygulama',
                    tags: ['eÄŸim', 'b deÄŸeri'],
                    explanation: {
                        correct: 'Bilinen nokta ve eÄŸimle b bulunur: y = mx + b denkleminde yerine koyup bâ€™yi Ã§Ã¶zdÃ¼n.',
                        wrong: 'Bir nokta ve eÄŸim verildiÄŸinde x ve yâ€™yi yerine koy, bâ€™yi yalnÄ±z bÄ±rak; denklem bu ÅŸekilde tamamlanÄ±r.'
                    }
                },
                {
                    topic: 'dogru_denklemi',
                    bloomLevel: 'uygulama',
                    tags: ['negatif eÄŸim', 'doÄŸru denklemi'],
                    explanation: {
                        correct: 'Negatif eÄŸim olsa da yÃ¶ntem aynÄ±; verilen nokta Ã¼zerinden b deÄŸerini izole ettin.',
                        wrong: 'EÄŸim negatif olsa bile denklem Ã§Ã¶zÃ¼m yolu deÄŸiÅŸmez; x ve yâ€™yi yerine yazÄ±p bâ€™yi bulabilirsin.'
                    }
                },
                {
                    topic: 'dogru_denklemi',
                    bloomLevel: 'kavrama',
                    tags: ['kesirli eÄŸim', 'b deÄŸeri'],
                    explanation: {
                        correct: 'Kesirli eÄŸimde de bâ€™yi bulmak iÃ§in x ve yâ€™yi yerine koyup toplama-Ã§Ä±karma yaptÄ±n.',
                        wrong: 'Kesirli katsayÄ±lar gÃ¶z korkutmasÄ±n; x ve yâ€™yi yerine yaz, adÄ±m adÄ±m bâ€™yi yalnÄ±z bÄ±rak.'
                    }
                },
                {
                    topic: 'dogru_denklemi',
                    bloomLevel: 'analiz',
                    tags: ['doÄŸru denklemi', 'iÅŸlemsel Ã§Ã¶zÃ¼m'],
                    explanation: {
                        correct: 'Verilen nokta ve eÄŸimle bâ€™yi Ã§Ã¶zdÃ¼n; y = mx + b formatÄ± seni doÄŸru sonuca gÃ¶tÃ¼rdÃ¼.',
                        wrong: 'x ve y deÄŸerlerini denklemde kullanÄ±p bâ€™yi bulmak, eÄŸim sorularÄ±nda hÄ±zlÄ± bir yÃ¶ntemdir.'
                    }
                }
            ],
            5: [
                {
                    topic: 'paralellik',
                    bloomLevel: 'bilgi',
                    tags: ['paralel', 'eÄŸim'],
                    explanation: {
                        correct: 'Paralel doÄŸrularÄ±n eÄŸimleri aynÄ±dÄ±r; b farklÄ±ysa doÄŸrular hiÃ§ kesiÅŸmez.',
                        wrong: 'Paralellik iÃ§in eÄŸimlerin eÅŸit olmasÄ±na bak; b farklÄ±ysa doÄŸrular uzak durur.'
                    }
                },
                {
                    topic: 'paralellik',
                    bloomLevel: 'kavrama',
                    tags: ['kesiÅŸim', 'eÄŸim'],
                    explanation: {
                        correct: 'EÄŸimler farklÄ±ysa doÄŸrular bir noktada kesiÅŸir; bunu fark ettin.',
                        wrong: 'FarklÄ± eÄŸimler doÄŸrularÄ± mutlaka kesiÅŸtirir; eÄŸim karÅŸÄ±laÅŸtÄ±rmasÄ± yeterli bir ipucudur.'
                    }
                },
                {
                    topic: 'paralellik',
                    bloomLevel: 'uygulama',
                    tags: ['Ã§akÄ±ÅŸÄ±k', 'doÄŸru denklemi'],
                    explanation: {
                        correct: 'EÄŸim ve b aynÄ±ysa doÄŸrular Ã¼st Ã¼ste biner; tÃ¼m noktalarÄ± paylaÅŸÄ±rlar.',
                        wrong: 'DoÄŸrularÄ±n hem eÄŸimi hem b deÄŸeri aynÄ±ysa aslÄ±nda tek bir doÄŸruyu anlatÄ±rlar.'
                    }
                },
                {
                    topic: 'paralellik',
                    bloomLevel: 'uygulama',
                    tags: ['paralel', 'sadeleÅŸtirme'],
                    explanation: {
                        correct: 'Denklemi sadeleÅŸtirince eÄŸimlerin eÅŸit olduÄŸunu gÃ¶rdÃ¼n; bâ€™ler farklÄ±ysa paralellik korunur.',
                        wrong: 'Denklemleri sadeleÅŸtirip eÄŸimleri karÅŸÄ±laÅŸtÄ±r; aynÄ± eÄŸim + farklÄ± b paralelliÄŸi gÃ¶sterir.'
                    }
                },
                {
                    topic: 'paralellik',
                    bloomLevel: 'analiz',
                    tags: ['Ã§akÄ±ÅŸÄ±k', 'eÅŸdeÄŸer denklem'],
                    explanation: {
                        correct: 'Her iki denklem de aynÄ± formu verdi; bu yÃ¼zden doÄŸrular Ã§akÄ±ÅŸÄ±k.',
                        wrong: 'Denklemler aynÄ± ÅŸekle geliyorsa aslÄ±nda tek doÄŸruyu anlatÄ±rlar; bu Ã§akÄ±ÅŸma anlamÄ±na gelir.'
                    }
                }
            ],
            6: [
                {
                    topic: 'diklik',
                    bloomLevel: 'uygulama',
                    tags: ['dik', 'eÄŸim'],
                    explanation: {
                        correct: 'Dik doÄŸrularÄ±n eÄŸimleri Ã§arpÄ±ldÄ±ÄŸÄ±nda -1 Ã§Ä±kar; 2 ile -1/2 Ã§arpÄ±mÄ± tam da bunu verir.',
                        wrong: 'Dik doÄŸrular iÃ§in mâ‚ Ã— mâ‚‚ = -1 kuralÄ±nÄ± kullan; 2â€™nin tersi -1/2 olmalÄ±dÄ±r.'
                    }
                },
                {
                    topic: 'diklik',
                    bloomLevel: 'kavrama',
                    tags: ['dik', 'negatif eÄŸim'],
                    explanation: {
                        correct: 'Negatif eÄŸimin dik karÅŸÄ±lÄ±ÄŸÄ± iÅŸaret deÄŸiÅŸtirip ters Ã§evrilir; -4 â†’ 1/4 iliÅŸkisini gÃ¶rdÃ¼n.',
                        wrong: 'Diklikte eÄŸimi ters Ã§evirip iÅŸaretini deÄŸiÅŸtir; -4 iÃ§in karÅŸÄ±lÄ±k 1/4 olmalÄ±.'
                    }
                },
                {
                    topic: 'diklik',
                    bloomLevel: 'uygulama',
                    tags: ['dik', 'kesirli'],
                    explanation: {
                        correct: 'Kesirli eÄŸimde de Ã§arpÄ±m -1 kuralÄ± geÃ§erli; 3/4â€™Ã¼n dik partneri -4/3â€™tÃ¼r.',
                        wrong: 'Kesirli eÄŸimleri ters Ã§evirip iÅŸaret deÄŸiÅŸtir; 3/4 â†’ -4/3 dÃ¶nÃ¼ÅŸÃ¼mÃ¼nÃ¼ uygulayabilirsin.'
                    }
                },
                {
                    topic: 'diklik',
                    bloomLevel: 'bilgi',
                    tags: ['yatay doÄŸru', 'tanÄ±msÄ±z'],
                    explanation: {
                        correct: 'Yatay doÄŸruya dik olan doÄŸru dÃ¼ÅŸeydir; x sabittir ve eÄŸim tanÄ±msÄ±zdÄ±r.',
                        wrong: 'Yatay doÄŸrularÄ±n dikleri dÃ¼ÅŸey olur; x sabit olduÄŸunda eÄŸim tanÄ±msÄ±zlaÅŸÄ±r.'
                    }
                },
                {
                    topic: 'diklik',
                    bloomLevel: 'analiz',
                    tags: ['dik', 'koordinat sistemi'],
                    explanation: {
                        correct: 'DÃ¼ÅŸey doÄŸruya dik olan doÄŸrular yataydÄ±r; y = k formu ile x eksenine paralel gider.',
                        wrong: 'x = k doÄŸrularÄ± dÃ¼ÅŸeydir; bunlara dik olan doÄŸrular y = k ÅŸeklinde yatay uzanÄ±r.'
                    }
                }
            ],
            7: [
                {
                    topic: 'hiz_orani',
                    bloomLevel: 'uygulama',
                    tags: ['grafik', 'oran'],
                    explanation: {
                        correct: 'y = 50x, her saat 50 km demektir; 4 saatte 4Ã—50 = 200 kmâ€™ye ulaÅŸtÄ±n.',
                        wrong: 'DoÄŸrunun eÄŸimi hÄ±zÄ±nÄ± verir; sÃ¼re ile Ã§arparak toplam yolu bulabilirsin (50Ã—4).'
                    }
                },
                {
                    topic: 'hiz_orani',
                    bloomLevel: 'uygulama',
                    tags: ['azalma', 'grafik'],
                    explanation: {
                        correct: 'Her saat 15 litre azalÄ±nca 4 saatte 60 litre gider; 120âˆ’60 = 60 litrelik sonucu yakaladÄ±n.',
                        wrong: 'DoÄŸrusal azalÄ±ÅŸta eÄŸim negatif miktarÄ± gÃ¶sterir; sÃ¼re ile Ã§arpÄ±p baÅŸlangÄ±Ã§tan Ã§Ä±kararak ilerleyebilirsin.'
                    }
                },
                {
                    topic: 'grafik',
                    bloomLevel: 'bilgi',
                    tags: ['eÄŸim', 'grafik okuma'],
                    explanation: {
                        correct: 'EÄŸim, iki nokta arasÄ±ndaki deÄŸiÅŸim oranÄ±dÄ±r; (0,0)-(5,15) iÃ§in 15/5 = 3 buldun.',
                        wrong: 'Grafikte eÄŸim iÃ§in y farkÄ±nÄ± x farkÄ±na bÃ¶l; 15/5 iÅŸlemi seni doÄŸru deÄŸere gÃ¶tÃ¼rÃ¼r.'
                    }
                },
                {
                    topic: 'grafik',
                    bloomLevel: 'analiz',
                    tags: ['karÅŸÄ±laÅŸtÄ±rma', 'eÄŸim'],
                    explanation: {
                        correct: 'EÄŸim bÃ¼yÃ¼dÃ¼kÃ§e doÄŸru dikleÅŸir; 5 eÄŸimi 2â€™den bÃ¼yÃ¼ktÃ¼r, bu yÃ¼zden y = 5x daha diktir.',
                        wrong: 'Hangi doÄŸru daha dik diye bakarken eÄŸimleri karÅŸÄ±laÅŸtÄ±r; bÃ¼yÃ¼k eÄŸim daha dik Ã§izgi demektir.'
                    }
                },
                {
                    topic: 'hiz_orani',
                    bloomLevel: 'kavrama',
                    tags: ['grafik', 'doÄŸru denklemi'],
                    explanation: {
                        correct: 'BaÅŸlangÄ±Ã§ deÄŸeri 10 ve eÄŸim 6 ise y = 6x + 10; x=3 iÃ§in 6Ã—3 + 10 = 28â€™i hesapladÄ±n.',
                        wrong: 'DoÄŸru denklemini okuyup xâ€™i yerine koyarak y deÄŸerini bulabilirsin; 6Ã—3â€™Ã¼ ekleyip 10â€™u unutma.'
                    }
                }
            ]
        };

        const conceptBlurbs = {
            'kadran': 'Kadranlarda iÅŸaretlerin birlikte nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶rdÃ¼n; koordinatlarÄ± okurken +/âˆ’ dÃ¼zenini kullandÄ±n.',
            'koordinat sistemi': 'Koordinat dÃ¼zleminde eksenleri ve bÃ¶lge ayrÄ±mlarÄ±nÄ± kullanarak konumlandÄ±rmayÄ± pekiÅŸtirdin.',
            'orijin': 'Orijin ve eksen kavramlarÄ±nÄ± kullanarak koordinatlarÄ±n Ã¶zel durumlarÄ±nÄ± hatÄ±rladÄ±n.',
            'negatif': 'Negatif deÄŸerleri okurken iÅŸaretlerin kadran seÃ§imini nasÄ±l deÄŸiÅŸtirdiÄŸini gÃ¶zlemledin.',
            'negatif y': 'Negatif y deÄŸerlerinin hangi kadranda yer aldÄ±ÄŸÄ±nÄ± kontrol etmeyi tekrar ettin.',
            'kesirli': 'Kesirli deÄŸerlerde de aynÄ± kural ve oranlarÄ± uygulayarak sonuÃ§larÄ± yorumladÄ±n.',
            'y ekseni': 'x=0 olduÄŸunda noktalarÄ±n y ekseni Ã¼zerinde kaldÄ±ÄŸÄ±nÄ± hatÄ±rladÄ±n.',
            'eÄŸim': 'Ä°ki nokta arasÄ±ndaki deÄŸiÅŸim oranÄ±nÄ± (eÄŸim) hesaplayarak doÄŸrularÄ±n yÃ¶nÃ¼nÃ¼ okudun.',
            'oran': 'Oran kurmayÄ± kullanarak hÄ±z, eÄŸim ve deÄŸiÅŸim miktarlarÄ±nÄ± iliÅŸkilendirdin.',
            'negatif eÄŸim': 'Azalan doÄŸrularda eÄŸimin negatif olduÄŸunu gÃ¶zlemledin.',
            'karÄ±ÅŸÄ±k iÅŸaret': 'FarklÄ± iÅŸaretlerle Ã§alÄ±ÅŸÄ±rken formÃ¼lÃ¼ koruyup iÅŸaretleri dikkatle yÃ¶netmeyi denedin.',
            'tanÄ±msÄ±z': 'Dikey doÄŸrularda eÄŸimin tanÄ±msÄ±z olduÄŸunu fark ederek Ã¶zel durumlarÄ± pekiÅŸtirdin.',
            'dikey doÄŸru': 'x farkÄ±nÄ±n 0 olduÄŸu doÄŸrularda eÄŸimin tanÄ±msÄ±z kaldÄ±ÄŸÄ±nÄ± hatÄ±rladÄ±n.',
            'aÃ§Ä±': 'AÃ§Ä± ve eÄŸim iliÅŸkisini tan ve Ã¶zel aÃ§Ä±larla baÄŸdaÅŸtÄ±rdÄ±n.',
            'yatay doÄŸru': 'Yatay doÄŸrularda eÄŸimin 0 olduÄŸu bilgisini kullandÄ±n.',
            'trigonometri': 'Tan deÄŸerleriyle eÄŸimleri iliÅŸkilendirerek aÃ§Ä±larÄ± daha iyi yorumladÄ±n.',
            'kesirli eÄŸim': 'Kesirli eÄŸimlerde oranÄ± sadeleÅŸtirerek yorum yapmayÄ± denedin.',
            'doÄŸru denklemi': 'y = mx + b formunu kullanarak doÄŸrularÄ± tanÄ±mlayÄ±p deÄŸer hesapladÄ±n.',
            'b deÄŸeri': 'b katsayÄ±sÄ±nÄ±n y eksenini kestiÄŸi noktayÄ± verdiÄŸini hatÄ±rladÄ±n.',
            'paralel': 'EÄŸimleri karÅŸÄ±laÅŸtÄ±rarak doÄŸrularÄ±n paralel olup olmadÄ±ÄŸÄ±nÄ± kontrol ettin.',
            'kesiÅŸim': 'EÄŸim farkÄ±yla doÄŸrularÄ±n kesiÅŸeceÄŸini yorumladÄ±n.',
            'Ã§akÄ±ÅŸÄ±k': 'EÄŸim ve b aynÄ±ysa doÄŸrularÄ±n aslÄ±nda tek Ã§izgi olduÄŸunu gÃ¶rdÃ¼n.',
            'sadeleÅŸtirme': 'Denklemleri sadeleÅŸtirerek eÄŸimleri ortaya Ã§Ä±karmayÄ± kullandÄ±n.',
            'eÅŸdeÄŸer denklem': 'EÅŸdeÄŸer denklemlerin aynÄ± doÄŸruyu verdiÄŸini fark ettin.',
            'dik': 'mâ‚ Ã— mâ‚‚ = -1 kuralÄ±nÄ± uygulayarak dik doÄŸrularÄ± belirledin.',
            'Ã§arpÄ±m -1': 'Diklikte eÄŸimlerin Ã§arpÄ±mÄ±nÄ±n -1 olmasÄ± gerektiÄŸini kullandÄ±n.',
            'azalma': 'Negatif eÄŸimli doÄŸrularda miktarÄ±n nasÄ±l azaldÄ±ÄŸÄ±nÄ± hesapladÄ±n.',
            'grafik': 'Grafiklerden eÄŸim ve deÄŸer okuyarak gerÃ§ek durumlarÄ± yorumladÄ±n.',
            'grafik okuma': 'Grafik Ã¼zerindeki iki noktadan eÄŸim hesaplayÄ±p grafiÄŸi yorumlamayÄ± kullandÄ±n.',
            'karÅŸÄ±laÅŸtÄ±rma': 'EÄŸimleri karÅŸÄ±laÅŸtÄ±rarak hangi doÄŸrunun daha dik olduÄŸunu seÃ§tin.'
        };

        function applyMetadataToBaseQuestions() {
            gameData.levels.forEach(level => {
                const metaList = questionMeta[level.id] || [];
                level.questions.forEach((question, index) => {
                    const meta = metaList[index] || {};
                    question.tags = question.tags || meta.tags || [];
                    question.topic = question.topic || meta.topic || '';
                    question.bloomLevel = question.bloomLevel || meta.bloomLevel || '';
                    question.explanation = question.explanation || meta.explanation || {
                        correct: 'DoÄŸru adÄ±mlarÄ± yakaladÄ±n; aynÄ± mantÄ±kla ilerlemeye devam et.',
                        wrong: 'Bir dahaki sefer kavramÄ±n temel tanÄ±mÄ±na odaklanarak iÅŸaretleri ve oranÄ± birlikte dÃ¼ÅŸÃ¼nmeyi dene.'
                    };
                });
            });
        }

        applyMetadataToBaseQuestions();

        // Oyun Motoru
        class Game {
            constructor() {
                this.currentLevel = 0;
                this.currentQuestion = 0;
                this.score = 0;
                this.correctAnswers = 0;
                this.wrongAnswers = 0;
                const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                this.settings = {
                    music: true,
                    effects: true,
                    speech: true,
                    lowPerf: prefersReducedMotion
                };
                this.timer = null;
                this.timeRemaining = 0;
                this.levelStartTime = 0;
                this.completedLevels = new Set();
                this.musicPlaying = true;
                this.totalScore = 0;
                this.totalCorrect = 0;
                this.audioContext = null;
                this.currentSpeech = null;
                this.wordInterval = null;
                this.musicNodes = [];
                this.currentQuestions = []; // SeÃ§ilen sorular
                this.questionPools = this.generateQuestionPools(); // Soru havuzlarÄ±
                this.isMobileViewport = window.matchMedia('(max-width: 480px)').matches;
                this.starCount = this.computeStarCount();
                this.particleBaseCount = this.computeParticleCount();
                this.hintAvailable = false;
                this.hintUsedThisQuestion = false;
                this.activeDialogues = [];
                this.dialogHighlightTimers = [];
                this.metaMap = questionMeta;
                this.conceptBlurbs = conceptBlurbs;
                this.bloomTargets = {
                    5: { bilgi: 1, kavrama: 1, uygulama: 2, analiz: 1 }
                };
                this.ambientAnimationFrame = null;
                this.lastAmbientTick = 0;

                this.initStars();
                this.startAmbientLoop();
                this.initMusicControl();
                this.initAudio();
                this.applyLowPerfMode();
            }

            computeStarCount() {
                const base = this.isMobileViewport ? 60 : 90;
                const narrowViewport = window.innerWidth < 600;
                const adjusted = narrowViewport ? Math.floor(base * 0.5) : base;
                return this.settings.lowPerf ? Math.max(8, Math.floor(adjusted * 0.3)) : adjusted;
            }

            computeParticleCount() {
                const base = this.isMobileViewport ? 6 : 12;
                return this.settings.lowPerf ? 0 : base;
            }

            generateQuestionPools() {
                // Her seviye iÃ§in 5 soru tipinin her biri iÃ§in 20 varyasyon
                const pools = {
                    level1: this.generateLevel1Pool(),
                    level2: this.generateLevel2Pool(),
                    level3: this.generateLevel3Pool(),
                    level4: this.generateLevel4Pool(),
                    level5: this.generateLevel5Pool(),
                    level6: this.generateLevel6Pool(),
                    level7: this.generateLevel7Pool()
                };
                return pools;
            }

            generateLevel1Pool() {
                const pool = [];

                // Soru 1: Birinci bÃ¶lge (x > 0, y > 0) - 20 varyasyon
                for (let i = 0; i < 20; i++) {
                    const x = Math.floor(Math.random() * 8) + 1;
                    const y = Math.floor(Math.random() * 8) + 1;
                    const wrongX = -(Math.floor(Math.random() * 5) + 1);
                    const wrongY = -(Math.floor(Math.random() * 5) + 1);
                    pool.push([this.withMeta(0, 0, {
                        difficulty: "Kolay",
                        text: `Pozitif bÃ¶lgede basit bir nokta: Hangisi birinci bÃ¶lgede (x > 0, y > 0) yer alÄ±r?`,
                        answers: [`(${x}, ${y})`, `(${wrongX}, ${y})`, `(${x}, ${wrongY})`, `(${wrongX}, ${wrongY})`],
                        correct: 0
                    })]);
                }

                // Soru 2: DÃ¶rdÃ¼ncÃ¼ bÃ¶lge (x > 0, y < 0) - 20 varyasyon
                for (let i = 0; i < 20; i++) {
                    const x = Math.floor(Math.random() * 8) + 1;
                    const y = Math.floor(Math.random() * 8) + 1;
                    pool[i].push(this.withMeta(0, 1, {
                        difficulty: "Kolay-Orta",
                        text: `Negatif y iÃ§eren nokta: Hangisi dÃ¶rdÃ¼ncÃ¼ bÃ¶lgede (x > 0, y < 0) yer alÄ±r?`,
                        answers: [`(${x}, ${y})`, `(${x}, ${-y})`, `(${-x}, ${-y})`, `(${-x}, ${y})`],
                        correct: 1
                    }));
                }

                // Soru 3: ÃœÃ§Ã¼ncÃ¼ bÃ¶lge (x < 0, y < 0) - 20 varyasyon
                for (let i = 0; i < 20; i++) {
                    const x = Math.floor(Math.random() * 7) + 1;
                    const y = Math.floor(Math.random() * 7) + 1;
                    pool[i].push(this.withMeta(0, 2, {
                        difficulty: "Orta",
                        text: `Hem negatif x hem negatif y: Hangisi Ã¼Ã§Ã¼ncÃ¼ bÃ¶lgede yer alÄ±r?`,
                        answers: [`(${x}, ${y})`, `(${-x}, ${y})`, `(${x}, ${-y})`, `(${-x}, ${-y})`],
                        correct: 3
                    }));
                }

                // Soru 4: Kesirli koordinatlar - 20 varyasyon
                for (let i = 0; i < 20; i++) {
                    const x1 = (Math.random() * 3 + 0.5).toFixed(1);
                    const y1 = (Math.random() * 3 + 0.5).toFixed(1);
                    const x2 = Math.floor(Math.random() * 5) + 1;
                    const y2 = Math.floor(Math.random() * 5) + 1;
                    pool[i].push(this.withMeta(0, 3, {
                        difficulty: "Orta-Zor",
                        text: `Kesirli koordinatlar: Hangisi doÄŸru kesirli koordinattÄ±r?`,
                        answers: [`(${x1}, ${y1})`, `(${x2}, ${y2})`, `(${-x2}, ${-y2})`, `(0, ${y2})`],
                        correct: 0
                    }));
                }

                // Soru 5: Y ekseni Ã¼zerinde - 20 varyasyon
                for (let i = 0; i < 20; i++) {
                    const y = Math.floor(Math.random() * 7) + 1;
                    const x = Math.floor(Math.random() * 5) + 1;
                    pool[i].push(this.withMeta(0, 4, {
                        difficulty: "Zor",
                        text: `Orijin ve eksenlere gÃ¶re Ã¶zel nokta: Hangisi y ekseninin Ã¼zerinde yer alÄ±r?`,
                        answers: [`(${x}, 0)`, `(0, ${y})`, `(${x}, ${y})`, `(0, 0)`],
                        correct: 1
                    }));
                }

                return pool;
            }

            generateLevel2Pool() {
                const pool = [];
                
                // Soru 1-5: EÄŸim sorularÄ± - Her biri iÃ§in 20 varyasyon
                for (let i = 0; i < 20; i++) {
                    const set = [];
                    
                    // S1: Pozitif eÄŸim
                    const x1 = Math.floor(Math.random() * 3) + 1;
                    const y1 = Math.floor(Math.random() * 3) + 2;
                    const x2 = x1 + Math.floor(Math.random() * 2) + 2;
                    const y2 = y1 + (x2 - x1) * (Math.floor(Math.random() * 3) + 1);
                    const slope = (y2 - y1) / (x2 - x1);
                    set.push(this.withMeta(1, 0, {
                        difficulty: "Kolay",
                        text: `Pozitif eÄŸimli tam sayÄ± noktalarÄ±: (${x1}, ${y1}) ve (${x2}, ${y2}) noktalarÄ± arasÄ±ndaki eÄŸim kaÃ§tÄ±r?`,
                        answers: [`${Math.floor(slope) - 1}`, `${Math.floor(slope)}`, `${Math.floor(slope) + 1}`, `${Math.floor(slope) + 2}`],
                        correct: 1
                    }));

                    set.push(this.withMeta(1, 1, {difficulty: "Kolay-Orta", text: "Negatif eÄŸimli iki nokta: x artarken y azalÄ±yor; eÄŸim kaÃ§tÄ±r?", answers: ["1", "-2", "2", "-1"], correct: 1}));
                    set.push(this.withMeta(1, 2, {difficulty: "Orta", text: "KarÄ±ÅŸÄ±k iÅŸaretli noktalar: EÄŸim oranÄ±nÄ± bul.", answers: ["1", "2", "3", "4"], correct: 1}));
                    set.push(this.withMeta(1, 3, {difficulty: "Orta-Zor", text: "Kesirli eÄŸim Ã¶rneÄŸi: FarklarÄ± oranla ve sadeleÅŸtir.", answers: ["1/2", "2/3", "3/4", "4/5"], correct: 2}));
                    set.push(this.withMeta(1, 4, {difficulty: "Zor", text: "x farkÄ± sÄ±fÄ±r olan dikey doÄŸru iÃ§in eÄŸim nedir?", answers: ["0", "TanÄ±msÄ±z", "1", "âˆ"], correct: 1}));

                    pool.push(set);
                }
                
                return pool;
            }

            // DiÄŸer seviyeler iÃ§in benzer havuzlar (basitleÅŸtirilmiÅŸ)
            generateLevel3Pool() { return this.generateSimplePool("AÃ§Ä±", 20, 2); }
            generateLevel4Pool() { return this.generateSimplePool("Denklem", 20, 3); }
            generateLevel5Pool() { return this.generateSimplePool("Paralel", 20, 4); }
            generateLevel6Pool() { return this.generateSimplePool("Dik", 20, 5); }
            generateLevel7Pool() { return this.generateSimplePool("Grafik", 20, 6); }

            generateSimplePool(type, count, levelIndex) {
                // Mevcut sorularÄ± kullan ama sayÄ±larÄ± deÄŸiÅŸtir
                const pool = [];
                const level = gameData.levels[levelIndex];

                for (let i = 0; i < count; i++) {
                    const set = level.questions.map((q, idx) => this.withMeta(levelIndex, idx, {...q}));
                    pool.push(set);
                }

                return pool;
            }

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            buildBloomMixedSet(pool, desiredCounts) {
                if (!pool || pool.length === 0) return null;
                const targetLength = pool[0]?.length || 0;
                if (!targetLength) return null;

                const flat = pool.flat().map((q, idx) => ({...q, _poolIndex: idx}));
                this.shuffleArray(flat);

                const remaining = {};
                Object.entries(desiredCounts).forEach(([key, value]) => {
                    remaining[key.toLowerCase()] = value;
                });

                const picked = [];
                const used = new Set();

                for (const q of flat) {
                    const bloomKey = (q.bloomLevel || '').toLowerCase();
                    if (remaining[bloomKey] > 0) {
                        picked.push(q);
                        used.add(q._poolIndex);
                        remaining[bloomKey] -= 1;
                    }
                }

                if (Object.values(remaining).some(count => count > 0)) {
                    return null; // Ä°stenen daÄŸÄ±lÄ±m yoksa havuza bÄ±rak
                }

                for (const q of flat) {
                    if (picked.length >= targetLength) break;
                    if (used.has(q._poolIndex)) continue;
                    picked.push(q);
                }

                return picked.slice(0, targetLength).map(q => {
                    const clone = {...q};
                    delete clone._poolIndex;
                    return clone;
                });
            }

            selectQuestionsFromPool(levelIndex) {
                const poolKey = `level${levelIndex + 1}`;
                const pool = this.questionPools[poolKey];

                if (!pool || pool.length === 0) {
                    console.warn(`âš ï¸ Seviye ${levelIndex + 1} iÃ§in soru havuzu bulunamadÄ±`);
                    this.currentQuestions = [];
                    return;
                }

                const desired = this.bloomTargets[pool?.[0]?.length || 0];
                const mixedSet = desired ? this.buildBloomMixedSet(pool, desired) : null;

                if (mixedSet && mixedSet.length) {
                    this.currentQuestions = mixedSet;
                    console.log(`ğŸ¯ Seviye ${levelIndex + 1} iÃ§in Bloom dengeli set oluÅŸturuldu`);
                } else {
                    const randomIndex = Math.floor(Math.random() * pool.length);
                    this.currentQuestions = pool[randomIndex];
                    console.log(`ğŸ² Seviye ${levelIndex + 1} iÃ§in ${randomIndex + 1}. soru seti seÃ§ildi (varsayÄ±lan)`);
                }

            }

            initStars() {
                const starsContainer = document.getElementById('stars');
                starsContainer.innerHTML = '';
                const count = this.computeStarCount();
                this.starElements = [];

                for (let i = 0; i < count; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    star.style.width = Math.random() * 2 + 1 + 'px';
                    star.style.height = star.style.width;
                    star.style.animationDelay = Math.random() * 2.5 + 's';
                    star.style.animationDuration = this.isMobileViewport
                        ? 4 + Math.random() * 1.5 + 's'
                        : 2.8 + Math.random() * 1.2 + 's';
                    starsContainer.appendChild(star);
                    this.starElements.push(star);
                }
            }

            startAmbientLoop() {
                this.stopAmbientLoop();
                const loop = (timestamp) => {
                    if (this.settings.lowPerf) {
                        this.ambientAnimationFrame = null;
                        return;
                    }

                    if (!this.lastAmbientTick) {
                        this.lastAmbientTick = timestamp;
                    }

                    if (timestamp - this.lastAmbientTick > 1200) {
                        this.subtleStarTwinkle();
                        this.lastAmbientTick = timestamp;
                    }

                    this.ambientAnimationFrame = requestAnimationFrame(loop);
                };

                this.ambientAnimationFrame = requestAnimationFrame(loop);
            }

            stopAmbientLoop() {
                if (this.ambientAnimationFrame) {
                    cancelAnimationFrame(this.ambientAnimationFrame);
                    this.ambientAnimationFrame = null;
                }
            }

            subtleStarTwinkle() {
                if (!this.starElements) return;
                this.starElements.forEach((star, index) => {
                    const twinkle = 0.65 + 0.35 * Math.sin((Date.now() / 800) + index);
                    star.style.opacity = twinkle.toFixed(2);
                });
            }

            initMusicControl() {
                const musicBtn = document.getElementById('musicControl');
                const panel = document.getElementById('audioPanel');
                const musicToggle = document.getElementById('musicToggle');
                const effectsToggle = document.getElementById('effectsToggle');
                const speechToggle = document.getElementById('speechToggle');
                const lowPerfToggle = document.getElementById('lowPerfToggle');

                const syncToggles = () => {
                    musicToggle.checked = this.settings.music;
                    effectsToggle.checked = this.settings.effects;
                    speechToggle.checked = this.settings.speech;
                    lowPerfToggle.checked = this.settings.lowPerf;
                    const icon = document.querySelector('.music-icon');
                    icon.textContent = this.settings.music ? 'ğŸ”Š' : 'ğŸ”‡';
                    this.updateReplayButtonState();
                };

                const togglePanel = () => {
                    const expanded = musicBtn.getAttribute('aria-expanded') === 'true';
                    musicBtn.setAttribute('aria-expanded', (!expanded).toString());
                    panel.hidden = expanded;
                };

                musicBtn.addEventListener('click', () => {
                    togglePanel();
                });

                musicBtn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        togglePanel();
                    }
                });

                musicToggle.addEventListener('change', () => {
                    this.settings.music = musicToggle.checked;
                    this.musicPlaying = this.settings.music;
                    if (!this.settings.music) {
                        this.stopAmbientMusic();
                    } else if (this.audioContext && this.musicNodes.length === 0) {
                        this.playAmbientMusic();
                    }
                    syncToggles();
                });

                effectsToggle.addEventListener('change', () => {
                    this.settings.effects = effectsToggle.checked;
                    syncToggles();
                });

                speechToggle.addEventListener('change', () => {
                    this.settings.speech = speechToggle.checked;
                    if (!this.settings.speech) {
                        this.clearDialogHighlights();
                        if (this.currentSpeech) {
                            window.speechSynthesis.cancel();
                            this.currentSpeech = null;
                        }
                    }
                    this.updateReplayButtonState();
                    syncToggles();
                });

                lowPerfToggle.addEventListener('change', () => {
                    this.settings.lowPerf = lowPerfToggle.checked;
                    this.applyLowPerfMode();
                    syncToggles();
                });

                syncToggles();
            }

            initAudio() {
                // Web Audio API ile uzay mÃ¼ziÄŸi oluÅŸtur
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('ğŸµ Audio Context oluÅŸturuldu');
                } catch (e) {
                    console.error('Audio Context hatasÄ±:', e);
                }
                
                // KullanÄ±cÄ± tÄ±kladÄ±ÄŸÄ±nda baÅŸlat
                const startAmbientMusic = () => {
                    if (this.audioContext && this.audioContext.state === 'suspended') {
                        this.audioContext.resume().then(() => {
                            console.log('ğŸµ Audio Context devam ediyor');
                        });
                    }

                    if (this.settings.music && this.musicPlaying && this.musicNodes.length === 0 && this.audioContext) {
                        this.playAmbientMusic();
                    }
                };
                
                // Ä°lk etkileÅŸimde baÅŸlat
                document.addEventListener('click', startAmbientMusic, { once: true });
                document.addEventListener('touchstart', startAmbientMusic, { once: true });
                
                // Buton tÄ±klamalarÄ±nda da kontrol et
                setTimeout(() => {
                    document.querySelectorAll('.btn, .answer-btn, .level-card').forEach(btn => {
                        btn.addEventListener('click', () => {
                            if (this.audioContext && this.audioContext.state === 'suspended') {
                                this.audioContext.resume();
                            }
                            if (this.settings.music && this.musicPlaying && this.musicNodes.length === 0 && this.audioContext) {
                                this.playAmbientMusic();
                            }
                        }, { once: true });
                    });
                }, 1000);
            }

            playAmbientMusic() {
                if (!this.settings.music) return;

                // EÄŸer zaten mÃ¼zik Ã§alÄ±yorsa yeniden baÅŸlatma
                if (this.musicNodes.length > 0) {
                    return;
                }

                // Uzay mÃ¼ziÄŸi iÃ§in dÃ¼ÅŸÃ¼k frekanslÄ± ambient tonlar
                const frequencies = [
                    { freq: 130.81, vol: 0.08, type: 'sine' },     // C3
                    { freq: 164.81, vol: 0.06, type: 'sine' },     // E3
                    { freq: 196.00, vol: 0.05, type: 'sine' },     // G3
                    { freq: 246.94, vol: 0.04, type: 'triangle' }, // B3
                ];

                frequencies.forEach((note, index) => {
                    setTimeout(() => {
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        const filter = this.audioContext.createBiquadFilter();

                        oscillator.type = note.type;
                        oscillator.frequency.value = note.freq;
                        
                        filter.type = 'lowpass';
                        filter.frequency.value = 800;
                        filter.Q.value = 1;

                        // Fade in
                        gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                        gainNode.gain.linearRampToValueAtTime(note.vol, this.audioContext.currentTime + 3);

                        oscillator.connect(filter);
                        filter.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);

                        oscillator.start();
                        
                        this.musicNodes.push({ oscillator, gainNode, filter });

                        // LFO efekti ekle (hafif titreÅŸim)
                        const lfo = this.audioContext.createOscillator();
                        const lfoGain = this.audioContext.createGain();
                        lfo.frequency.value = 0.2 + (index * 0.1); // YavaÅŸ LFO
                        lfoGain.gain.value = 8;
                        lfo.connect(lfoGain);
                        lfoGain.connect(oscillator.frequency);
                        lfo.start();
                    }, index * 800); // Stagger baÅŸlangÄ±Ã§
                });

                console.log('ğŸµ Arka plan mÃ¼ziÄŸi baÅŸladÄ±');
            }

            stopAmbientMusic() {
                if (this.musicNodes.length === 0) return;

                this.musicNodes.forEach(node => {
                    // Fade out
                    node.gainNode.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + 1);
                    node.oscillator.stop(this.audioContext.currentTime + 1);
                });
                
                this.musicNodes = [];
                console.log('ğŸ”‡ Arka plan mÃ¼ziÄŸi durduruldu');
            }

            playSound(type) {
                if (!this.settings.effects) return;
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                if (type === 'correct') {
                    // DoÄŸru cevap - tok ve gÃ¼Ã§lÃ¼ pozitif ses (dÃ¼ÅŸÃ¼k frekanslÄ± bass + click)
                    
                    // Bass vuruÅŸ
                    const bass = audioCtx.createOscillator();
                    const bassGain = audioCtx.createGain();
                    bass.type = 'sine';
                    bass.frequency.value = 80; // DÃ¼ÅŸÃ¼k bass frekansÄ±
                    bassGain.gain.setValueAtTime(0.4, audioCtx.currentTime);
                    bassGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    bass.connect(bassGain);
                    bassGain.connect(audioCtx.destination);
                    bass.start(audioCtx.currentTime);
                    bass.stop(audioCtx.currentTime + 0.3);
                    
                    // Tok click sesi
                    const click = audioCtx.createOscillator();
                    const clickGain = audioCtx.createGain();
                    click.type = 'square';
                    click.frequency.value = 200;
                    clickGain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    clickGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    click.connect(clickGain);
                    clickGain.connect(audioCtx.destination);
                    click.start(audioCtx.currentTime);
                    click.stop(audioCtx.currentTime + 0.1);
                    
                    // Ãœst melodi (daha yumuÅŸak)
                    setTimeout(() => {
                        const melody = audioCtx.createOscillator();
                        const melodyGain = audioCtx.createGain();
                        melody.type = 'sine';
                        melody.frequency.value = 300;
                        melodyGain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                        melodyGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                        melody.connect(melodyGain);
                        melodyGain.connect(audioCtx.destination);
                        melody.start(audioCtx.currentTime);
                        melody.stop(audioCtx.currentTime + 0.2);
                    }, 50);
                    
                } else if (type === 'wrong') {
                    // YanlÄ±ÅŸ cevap - tok ve karanlÄ±k hata sesi (dÃ¼ÅŸÃ¼k buzz)
                    
                    // DÃ¼ÅŸÃ¼k buzz sesi
                    const buzz = audioCtx.createOscillator();
                    const buzzGain = audioCtx.createGain();
                    buzz.type = 'sawtooth';
                    buzz.frequency.value = 60; // Ã‡ok dÃ¼ÅŸÃ¼k frekans
                    buzzGain.gain.setValueAtTime(0.4, audioCtx.currentTime);
                    buzzGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                    buzz.connect(buzzGain);
                    buzzGain.connect(audioCtx.destination);
                    buzz.start(audioCtx.currentTime);
                    buzz.stop(audioCtx.currentTime + 0.4);
                    
                    // Orta frekans katman
                    const mid = audioCtx.createOscillator();
                    const midGain = audioCtx.createGain();
                    mid.type = 'square';
                    mid.frequency.value = 120;
                    midGain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    midGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    mid.connect(midGain);
                    midGain.connect(audioCtx.destination);
                    mid.start(audioCtx.currentTime);
                    mid.stop(audioCtx.currentTime + 0.3);
                    
                    // Noise burst (beyaz gÃ¼rÃ¼ltÃ¼ etkisi)
                    const noise = audioCtx.createBufferSource();
                    const noiseGain = audioCtx.createGain();
                    const bufferSize = audioCtx.sampleRate * 0.1;
                    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = Math.random() * 2 - 1;
                    }
                    noise.buffer = buffer;
                    noiseGain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    noiseGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    noise.connect(noiseGain);
                    noiseGain.connect(audioCtx.destination);
                    noise.start(audioCtx.currentTime);
                    
                } else if (type === 'complete') {
                    // Seviye tamamlama - tok ve zafer dolu melodi
                    const frequencies = [130.81, 164.81, 196.00]; // C3, E3, G3 (daha dÃ¼ÅŸÃ¼k oktav)
                    frequencies.forEach((freq, i) => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.type = 'sine';
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.3, audioCtx.currentTime + i * 0.15);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.15 + 0.4);
                        osc.start(audioCtx.currentTime + i * 0.15);
                        osc.stop(audioCtx.currentTime + i * 0.15 + 0.4);
                    });
                    
                } else if (type === 'click') {
                    // Buton tÄ±klama sesi - TOK ve GÃœÃ‡LÃœ (konsol tarzÄ±)
                    
                    // Ana bass vuruÅŸ
                    const bass = audioCtx.createOscillator();
                    const bassGain = audioCtx.createGain();
                    bass.type = 'sine';
                    bass.frequency.value = 150; // Orta-dÃ¼ÅŸÃ¼k frekans
                    bassGain.gain.setValueAtTime(0.35, audioCtx.currentTime);
                    bassGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.12);
                    bass.connect(bassGain);
                    bassGain.connect(audioCtx.destination);
                    bass.start(audioCtx.currentTime);
                    bass.stop(audioCtx.currentTime + 0.12);
                    
                    // Tok click katmanÄ±
                    const click = audioCtx.createOscillator();
                    const clickGain = audioCtx.createGain();
                    click.type = 'square';
                    click.frequency.value = 250;
                    clickGain.gain.setValueAtTime(0.25, audioCtx.currentTime);
                    clickGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.06);
                    click.connect(clickGain);
                    clickGain.connect(audioCtx.destination);
                    click.start(audioCtx.currentTime);
                    click.stop(audioCtx.currentTime + 0.06);
                    
                    // Noise burst (mekanik his)
                    const noise = audioCtx.createBufferSource();
                    const noiseGain = audioCtx.createGain();
                    const bufferSize = audioCtx.sampleRate * 0.03;
                    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = (Math.random() * 2 - 1) * 0.5;
                    }
                    noise.buffer = buffer;
                    noiseGain.gain.setValueAtTime(0.15, audioCtx.currentTime);
                    noiseGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.03);
                    noise.connect(noiseGain);
                    noiseGain.connect(audioCtx.destination);
                    noise.start(audioCtx.currentTime);
                    
                } else if (type === 'hover') {
                    // Hover sesi - TOK ama hafif (mekanik tÄ±kÄ±rtÄ±)
                    
                    // Bass katman
                    const bass = audioCtx.createOscillator();
                    const bassGain = audioCtx.createGain();
                    bass.type = 'sine';
                    bass.frequency.value = 200; // Orta-dÃ¼ÅŸÃ¼k
                    bassGain.gain.setValueAtTime(0.08, audioCtx.currentTime);
                    bassGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);
                    bass.connect(bassGain);
                    bassGain.connect(audioCtx.destination);
                    bass.start(audioCtx.currentTime);
                    bass.stop(audioCtx.currentTime + 0.08);
                    
                    // Hafif click
                    const click = audioCtx.createOscillator();
                    const clickGain = audioCtx.createGain();
                    click.type = 'square';
                    click.frequency.value = 300;
                    clickGain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    clickGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.04);
                    click.connect(clickGain);
                    clickGain.connect(audioCtx.destination);
                    click.start(audioCtx.currentTime);
                    click.stop(audioCtx.currentTime + 0.04);
                    
                    // Ã‡ok hafif noise
                    const noise = audioCtx.createBufferSource();
                    const noiseGain = audioCtx.createGain();
                    const bufferSize = audioCtx.sampleRate * 0.02;
                    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        data[i] = (Math.random() * 2 - 1) * 0.3;
                    }
                    noise.buffer = buffer;
                    noiseGain.gain.setValueAtTime(0.04, audioCtx.currentTime);
                    noiseGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.02);
                    noise.connect(noiseGain);
                    noiseGain.connect(audioCtx.destination);
                    noise.start(audioCtx.currentTime);
                }
            }

            // Ripple efekti oluÅŸtur
            createRipple(event, element) {
                const ripple = document.createElement('span');
                ripple.classList.add('ripple');
                
                const rect = element.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = event.clientX - rect.left - size / 2;
                const y = event.clientY - rect.top - size / 2;
                
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                
                element.appendChild(ripple);
                
                setTimeout(() => ripple.remove(), 600);
            }

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');

                const shouldPauseAmbient = screenId === 'welcomeScreen' || screenId === 'levelSelectScreen';
                document.body.classList.toggle('ambient-paused', shouldPauseAmbient);
            }

            applyLowPerfMode() {
                document.body.classList.toggle('low-perf', this.settings.lowPerf);
                document.getElementById('stars').classList.toggle('muted', this.settings.lowPerf);
                this.particleBaseCount = this.computeParticleCount();
                this.starCount = this.computeStarCount();

                if (this.settings.lowPerf) {
                    this.stopAmbientLoop();
                    this.clearParticles();
                } else {
                    this.startAmbientLoop();
                }

                this.initStars();

                if (!this.settings.lowPerf && document.getElementById('gameScreen').classList.contains('active')) {
                    this.clearParticles();
                    this.createLevelParticles((this.currentLevel || 0) + 1);
                }
            }

            showWelcome() {
                // TemayÄ± temizle
                const keepLowPerf = document.body.classList.contains('low-perf');
                document.body.className = '';
                if (keepLowPerf) document.body.classList.add('low-perf');
                this.stopActiveLoops();
                this.clearParticles();
                this.resetStars();

                this.showScreen('welcomeScreen');
            }

            resetStars() {
                const stars = document.querySelectorAll('.star');
                stars.forEach(star => {
                    star.style.background = 'white';
                    star.style.boxShadow = '0 0 10px white';
                    star.classList.remove('shooting');
                });
            }

            showLevelSelect() {
                // TemayÄ± temizle
                const keepLowPerf = document.body.classList.contains('low-perf');
                document.body.className = '';
                if (keepLowPerf) document.body.classList.add('low-perf');
                this.stopActiveLoops();
                this.clearParticles();
                this.resetStars();

                this.showScreen('levelSelectScreen');
                this.renderLevelSelect();
            }

            getLevelTheme(levelId) {
                return levelThemes[levelId] || null;
            }

            getLevelBloomFocus(level) {
                if (!level || !level.questions) return '';
                const counts = {};
                level.questions.forEach(q => {
                    const label = this.formatBloomLabel(q.bloomLevel);
                    if (!label) return;
                    counts[label] = (counts[label] || 0) + 1;
                });

                const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                if (sorted.length === 0) return '';

                const topTwo = sorted.slice(0, 2).map(entry => entry[0]);
                return `Odak: ${topTwo.join(' + ')}`;
            }

            stopActiveLoops() {
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }

                if (this.wordInterval) {
                    clearInterval(this.wordInterval);
                    this.wordInterval = null;
                }

                if (this.currentSpeech) {
                    window.speechSynthesis.cancel();
                    this.currentSpeech = null;
                }

                this.stopAmbientLoop();
            }

            renderLevelSelect() {
                const grid = document.getElementById('levelsGrid');
                grid.innerHTML = '';

                gameData.levels.forEach((level, index) => {
                    const card = document.createElement('div');
                    card.className = 'level-card';

                    const theme = this.getLevelTheme(level.id);
                    const isLocked = index > 0 && !this.completedLevels.has(index);
                    if (isLocked) {
                        card.classList.add('locked');
                    }

                    const badgeIcon = level.badge ? this.getBadgeIcon(level.badge) : '';
                    const status = this.completedLevels.has(index + 1) ? 'âœ…' :
                                   isLocked ? 'ğŸ”’' : 'â­';
                    const bloomFocus = this.getLevelBloomFocus(level);

                    if (theme?.primaryColor) {
                        card.style.setProperty('--level-accent', theme.primaryColor);
                    }

                    card.innerHTML = `
                        <div class="level-meta">
                            ${badgeIcon ? `<span class="level-badge-mini" title="${level.badge}">${badgeIcon}</span>` : ''}
                            ${this.completedLevels.has(index + 1) ? '<span class="level-complete-tick" title="TamamlandÄ±">âœ”</span>' : ''}
                        </div>
                        ${theme ? `<div class="level-theme-tag" aria-label="${theme.name}">
                            <span class="theme-strip" aria-hidden="true"></span>
                            <span class="theme-icon">${theme.icon || 'â­'}</span>
                            <span class="theme-name">${theme.name}</span>
                        </div>` : ''}
                        <div class="level-status">${status}</div>
                        <div class="level-number">${level.id}</div>
                        <div class="level-title">${level.title}</div>
                        <div class="level-info">â±ï¸ ${Math.floor(level.time / 60)} dakika</div>
                        <div class="level-info">ğŸ“ ${level.questions.length} Soru</div>
                        ${bloomFocus ? `<div class="level-bloom">${bloomFocus}</div>` : ''}
                    `;

                    if (!isLocked) {
                        // Hover sesi
                        card.addEventListener('mouseenter', () => {
                            this.playSound('hover');
                        });
                        
                        // TÄ±klama sesi
                        card.addEventListener('click', (e) => {
                            this.playSound('click');
                            this.createRipple(e, card);
                            setTimeout(() => this.startLevel(index), 200);
                        });
                    }

                    grid.appendChild(card);
                });
            }

            startLevel(levelIndex) {
                this.currentLevel = levelIndex;
                this.currentQuestion = 0;
                this.correctAnswers = 0;
                this.wrongAnswers = 0;
                this.levelStartTime = Date.now();
                this.hintAvailable = false;
                this.hintUsedThisQuestion = false;
                this.updateHintBar(false);

                const level = gameData.levels[levelIndex];
                this.timeRemaining = level.time;

                if (this.settings.lowPerf) {
                    this.stopAmbientLoop();
                } else {
                    this.startAmbientLoop();
                }

                // SORU HAVUZUNDAN SEÃ‡
                this.selectQuestionsFromPool(levelIndex);

                // Seviye temasÄ±nÄ± uygula
                this.applyLevelTheme(levelIndex);

                this.showScreen('gameScreen');
                this.updateLevelInfo();
                
                if (this.settings.speech) {
                    this.loadVoices().then(() => {
                        this.showStoryAndQuestion();
                    });
                } else {
                    this.showStoryAndQuestion();
                }
                
                this.startTimer();
            }

            loadVoices() {
                return new Promise((resolve) => {
                    let voices = window.speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        console.log('ğŸ™ï¸ Sesler yÃ¼klendi:', voices.length);
                        resolve(voices);
                    } else {
                        window.speechSynthesis.onvoiceschanged = () => {
                            voices = window.speechSynthesis.getVoices();
                            console.log('ğŸ™ï¸ Sesler gÃ¼ncellendi:', voices.length);
                            resolve(voices);
                        };
                    }
                });
            }

            applyLevelTheme(levelIndex) {
                const keepLowPerf = document.body.classList.contains('low-perf');
                document.body.className = '';
                if (keepLowPerf) document.body.classList.add('low-perf');

                const theme = this.getLevelTheme(levelIndex + 1);
                const levelClass = `level-${levelIndex + 1}`;
                document.body.classList.add(levelClass);
                if (theme?.backgroundClass) {
                    document.body.classList.add(theme.backgroundClass);
                }

                const root = document.documentElement;
                root.style.setProperty('--theme-primary', theme?.primaryColor || '#38bdf8');
                root.style.setProperty('--theme-secondary', theme?.secondaryColor || '#0f172a');

                this.clearParticles();
                this.createLevelParticles(levelIndex + 1);

                this.updateStars(levelIndex + 1, theme);
            }

            clearParticles() {
                document.querySelectorAll('.particle').forEach(p => p.remove());
            }

            createLevelParticles(levelNum) {
                if (this.settings.lowPerf) return;
                const particleCount = this.isMobileViewport ? Math.ceil(this.particleBaseCount * 0.7) : this.particleBaseCount;
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = `particle level-${levelNum}`;
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 3 + 's';
                    if (this.isMobileViewport) {
                        particle.style.animationDuration = '6s';
                    }
                    document.body.appendChild(particle);
                }
            }

            updateStars(levelNum, themeConfig) {
                const stars = document.querySelectorAll('.star');
                const colors = {
                    1: '#64b5f6',
                    2: '#81c784',
                    3: '#ba68c8',
                    4: '#ffb74d',
                    5: '#4fc3f7',
                    6: '#e57373',
                    7: '#4db6ac'
                };
                const preferred = themeConfig?.primaryColor || colors[levelNum] || 'white';

                stars.forEach((star, index) => {
                    star.style.background = preferred;
                    star.style.boxShadow = this.settings.lowPerf
                        ? `0 0 4px ${preferred}`
                        : `0 0 10px ${preferred}`;

                    if (!this.settings.lowPerf && index % 12 === 0) {
                        star.classList.add('shooting');
                    } else {
                        star.classList.remove('shooting');
                    }
                });
            }

            updateLevelInfo() {
                const level = gameData.levels[this.currentLevel];
                const theme = this.getLevelTheme(level.id);
                const icon = theme?.icon || 'â­';

                const titleElement = document.getElementById('currentLevelTitle');
                titleElement.textContent = `Seviye ${level.id}: ${level.title}`;
                titleElement.setAttribute('data-icon', icon);

                document.getElementById('currentLevelDesc').textContent = level.description;
            }

            getBadgeIcon(badge) {
                const map = {
                    'HÄ±zlÄ±': 'âš¡',
                    'Kesin NiÅŸancÄ±': 'ğŸ¯',
                    'DayanÄ±klÄ±': 'â­'
                };
                return map[badge] || 'â­';
            }

            calculateBadge(level) {
                const timeRatio = level.time > 0 ? this.timeRemaining / level.time : 0;

                if (this.wrongAnswers === 0) {
                    return 'Kesin NiÅŸancÄ±';
                }
                if (timeRatio > 0.4) {
                    return 'HÄ±zlÄ±';
                }
                if (timeRatio < 0.2) {
                    return 'DayanÄ±klÄ±';
                }
                return null;
            }

            highlightMathTerms(text) {
                if (!text) return '';

                const terms = [
                    'analitik dÃ¼zlem',
                    'doÄŸru denklemi',
                    'koordinat sistemi',
                    'eÄŸim',
                    'kadran',
                    'paralel',
                    'tanÄ±msÄ±z',
                    'dikey',
                    'y ekseni',
                    'x ekseni',
                    'aÃ§Ä±'
                ];

                let highlighted = text;

                terms.sort((a, b) => b.length - a.length).forEach(term => {
                    const pattern = new RegExp(`(${term.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                    highlighted = highlighted.replace(pattern, '<span class="math-term">$1</span>');
                });

                return highlighted;
            }

            formatTopicLabel(topic) {
                if (!topic) return '';
                const map = {
                    egim: 'EÄŸim',
                    dogru_denklemi: 'DoÄŸru Denklemi',
                    kadran: 'Kadran',
                    paralellik: 'Paralellik',
                    diklik: 'Diklik',
                    grafik: 'Grafik Okuma',
                    trigonometrik_egim: 'AÃ§Ä±-EÄŸim',
                    koordinat: 'Koordinat',
                    orijin: 'Orijin',
                    hiz_orani: 'HÄ±z-Oran',
                    sekil: 'Åekil',
                    oran: 'Oran'
                };
                return map[topic] || topic;
            }

            formatBloomLabel(level) {
                if (!level) return '';
                const normalized = level.toLowerCase();
                const map = {
                    bilgi: 'Bilgi',
                    kavrama: 'Kavrama',
                    uygulama: 'Uygulama',
                    analiz: 'Analiz'
                };
                return map[normalized] || level;
            }

            getQuestionMeta(levelIndex, questionIndex) {
                return (this.metaMap[levelIndex + 1] && this.metaMap[levelIndex + 1][questionIndex]) || {};
            }

            ensureQuestionMeta(question, levelIndex, questionIndex) {
                const baseMeta = this.getQuestionMeta(levelIndex, questionIndex);
                const enriched = {...question};

                if (!enriched.tags || enriched.tags.length === 0) {
                    enriched.tags = baseMeta.tags ? [...baseMeta.tags] : [];
                }

                if (!enriched.topic) {
                    enriched.topic = baseMeta.topic || '';
                }

                if (!enriched.bloomLevel) {
                    enriched.bloomLevel = baseMeta.bloomLevel || '';
                }

                if (!enriched.explanation) {
                    enriched.explanation = baseMeta.explanation || {
                        correct: 'DoÄŸru mantÄ±ÄŸÄ± takip ettin; aynÄ± yaklaÅŸÄ±mÄ± sÃ¼rdÃ¼r.',
                        wrong: 'Bir dahaki sefer temel iliÅŸkiye odaklanarak iÅŸaret ve oranlarÄ± birlikte gÃ¶zden geÃ§ir.'
                    };
                }

                return enriched;
            }

            withMeta(levelIndex, questionIndex, question) {
                return this.ensureQuestionMeta(question, levelIndex, questionIndex);
            }

            hideExplanationBox() {
                const box = document.getElementById('explanationBox');
                if (!box) return;
                box.classList.add('hidden');
                box.classList.remove('correct', 'wrong');
                box.innerHTML = '';
            }

            renderExplanation(question, isCorrect) {
                const box = document.getElementById('explanationBox');
                if (!box) return;

                const explanationText = isCorrect
                    ? question.explanation?.correct
                    : question.explanation?.wrong;

                if (!explanationText) {
                    this.hideExplanationBox();
                    return;
                }

                box.innerHTML = `<strong>${isCorrect ? 'Neden doÄŸru?' : 'Birlikte bakalÄ±m:'}</strong> ${this.highlightMathTerms(explanationText)}`;
                box.classList.toggle('correct', isCorrect);
                box.classList.toggle('wrong', !isCorrect);
                box.classList.remove('hidden');
            }

            buildLearningSummary() {
                const tagSet = new Set();
                this.currentQuestions.forEach(q => {
                    (q.tags || []).forEach(tag => tagSet.add(tag));
                });

                const blurbs = [];
                tagSet.forEach(tag => {
                    if (blurbs.length >= 3) return;
                    const text = this.conceptBlurbs[tag];
                    if (text) {
                        blurbs.push(text);
                    }
                });

                return blurbs;
            }

            renderLearningSummary(items) {
                const wrapper = document.getElementById('learningSummary');
                const list = document.getElementById('learningSummaryList');
                if (!wrapper || !list) return;

                if (!items || items.length === 0) {
                    wrapper.classList.add('hidden');
                    list.innerHTML = '';
                    return;
                }

                list.innerHTML = items
                    .map(text => `<li>${this.highlightMathTerms(text)}</li>`)
                    .join('');
                wrapper.classList.remove('hidden');
            }

            buildBloomSummaryText() {
                const counts = {};
                this.currentQuestions.forEach(q => {
                    const label = this.formatBloomLabel(q.bloomLevel);
                    if (!label) return;
                    counts[label] = (counts[label] || 0) + 1;
                });

                const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                if (entries.length === 0) return '';

                const fragments = entries.map(([label, value]) => `${value} ${label}`);
                return `Bu seviyede ${fragments.join(', ')} sorusu Ã§Ã¶zdÃ¼n.`;
            }

            renderBloomSummary(text) {
                const panel = document.getElementById('bloomSummary');
                if (!panel) return;

                if (!text) {
                    panel.textContent = '';
                    panel.classList.add('hidden');
                    return;
                }

                panel.textContent = text;
                panel.classList.remove('hidden');
            }

            buildDialogues(story) {
                const primary = story.character === 'ğŸ¤–' ? 'Orion'
                    : story.character === 'ğŸ‘¨â€ğŸš€' ? 'Axel'
                    : 'Axel';
                const secondary = primary === 'Axel' ? 'Orion' : 'Axel';
                let sentences = (story.text || '').split(/(?<=[.!?])\s+/).filter(Boolean);

                const maxLines = 3;
                if (sentences.length > maxLines) {
                    const trimmed = sentences.slice(0, maxLines - 1);
                    trimmed.push(sentences.slice(maxLines - 1).join(' '));
                    sentences = trimmed;
                }

                if (sentences.length === 0) {
                    sentences = [story.text || ''];
                }

                return sentences.map((sentence, index) => ({
                    speaker: index % 2 === 0 ? primary : secondary,
                    text: sentence
                }));
            }

            renderDialogues(dialogues) {
                const storyTextElement = document.getElementById('storyText');
                storyTextElement.innerHTML = '';

                dialogues.forEach(dialogue => {
                    const bubble = document.createElement('div');
                    bubble.className = `dialog-bubble dialog-${dialogue.speaker.toLowerCase()}`;
                    bubble.innerHTML = `<span class="dialog-speaker">${dialogue.speaker}:</span> ${this.highlightMathTerms(dialogue.text)}`;
                    storyTextElement.appendChild(bubble);
                });
            }

            clearDialogHighlights() {
                const bubbles = document.querySelectorAll('.dialog-bubble');
                bubbles.forEach(b => b.classList.remove('active'));
                this.dialogHighlightTimers.forEach(timer => clearTimeout(timer));
                this.dialogHighlightTimers = [];
            }

            updateReplayButtonState() {
                const replayBtn = document.getElementById('replayStoryBtn');
                if (!replayBtn) return;
                const speechAllowed = this.settings.speech;
                replayBtn.classList.toggle('hidden', !speechAllowed);
                replayBtn.disabled = !speechAllowed || !!this.currentSpeech;
            }

            showStoryAndQuestion() {
                const level = gameData.levels[this.currentLevel];
                const story = level.stories[this.currentQuestion];
                this.currentStory = story;
                const question = this.ensureQuestionMeta(
                    this.currentQuestions[this.currentQuestion],
                    this.currentLevel,
                    this.currentQuestion
                );
                this.currentQuestions[this.currentQuestion] = question;
                this.hintUsedThisQuestion = false;
                this.updateHintBar();
                this.clearDialogHighlights();
                this.hideExplanationBox();

                // Soru kartÄ±nÄ± gizle
                const questionCard = document.getElementById('questionCard');
                questionCard.style.display = 'none';
                questionCard.classList.remove('shake');

                // Hikaye gÃ¶ster
                document.getElementById('storyCharacter').textContent = story.character;
                document.getElementById('storyTitle').textContent = story.title;
                this.activeDialogues = this.buildDialogues(story);
                this.renderDialogues(this.activeDialogues);

                // Soru bilgilerini hazÄ±rla
                const questionNum = this.currentQuestion + 1;
                const difficulty = question.difficulty || '';

                document.getElementById('questionNumber').textContent =
                    `Soru ${questionNum}/${this.currentQuestions.length} â€¢ ${difficulty}`;
                const topicLabel = this.formatTopicLabel(question.topic);
                const bloomLabel = this.formatBloomLabel(question.bloomLevel);
                const metaLine = [
                    topicLabel ? `Konu: ${topicLabel}` : null,
                    bloomLabel ? `DÃ¼zey: ${bloomLabel}` : null
                ].filter(Boolean).join(' | ');
                const metaEl = document.getElementById('questionMeta');
                metaEl.textContent = metaLine;
                metaEl.classList.toggle('hidden', !metaLine);
                document.getElementById('questionText').innerHTML = this.highlightMathTerms(question.text);

                const answersGrid = document.getElementById('answersGrid');
                answersGrid.innerHTML = '';

                question.answers.forEach((answer, index) => {
                    const button = document.createElement('button');
                    button.className = 'answer-btn';
                    button.textContent = answer;
                    
                    // Hover sesi ekle
                    button.addEventListener('mouseenter', () => {
                        this.playSound('hover');
                    });
                    
                    // TÄ±klama sesi ve ripple efekti
                    button.addEventListener('click', (e) => {
                        this.playSound('click');
                        this.createRipple(e, button);
                    });
                    
                    button.onclick = () => this.checkAnswer(index);
                    answersGrid.appendChild(button);
                });

                this.updateProgress();
                this.updateReplayButtonState();

                // Seslendirme baÅŸlat
                this.narrateStory(story, () => {
                    // Seslendirme bitince soruyu gÃ¶ster
                    document.getElementById('questionCard').style.display = 'block';
                    document.getElementById('questionCard').style.animation = 'slideInRight 0.28s ease';
                });
            }

            narrateStory(story, onComplete) {
                // Ã–nceki seslendirmeyi durdur
                if (this.currentSpeech) {
                    window.speechSynthesis.cancel();
                }

                if (this.wordInterval) {
                    clearInterval(this.wordInterval);
                    this.wordInterval = null;
                }

                const dialogues = this.activeDialogues && this.activeDialogues.length > 0
                    ? this.activeDialogues
                    : this.buildDialogues(story);

                const paragraphs = dialogues.map(d => `${d.speaker}: ${d.text}`);
                const speechText = story.text || paragraphs.join(' ');
                const storyTextElement = document.getElementById('storyText');

                this.dialogHighlightTimers.forEach(timer => clearTimeout(timer));
                this.dialogHighlightTimers = [];

                if (!this.settings.speech) {
                    this.currentSpeech = null;
                    this.renderDialogues(dialogues);
                    this.clearDialogHighlights();
                    this.updateReplayButtonState();
                    if (onComplete) {
                        setTimeout(onComplete, 300);
                    }
                    return;
                }

                // Sesleri yÃ¼kle ve en iyi TÃ¼rkÃ§e sesi seÃ§
                this.loadVoices().then(voices => {
                    // Web Speech API
                    const speech = new SpeechSynthesisUtterance(speechText);
                    this.currentSpeech = speech;
                    this.updateReplayButtonState();
                    
                    // En iyi TÃ¼rkÃ§e sesi seÃ§ - kaliteli ve akÄ±cÄ± olanlar Ã¶ncelikli
                    const turkishVoice = 
                        // Google sesler (en akÄ±cÄ±)
                        voices.find(v => v.name.includes('Google') && v.lang.startsWith('tr')) ||
                        // Microsoft sesler
                        voices.find(v => v.name.includes('Microsoft') && v.lang.startsWith('tr')) ||
                        // Erkek sesler - premium
                        voices.find(v => v.lang.startsWith('tr') && 
                            (v.name.includes('Ahmet') || v.name.includes('Tolga') || 
                             v.name.includes('Kerem') || v.name.includes('Murat'))) ||
                        // Genel erkek sesler
                        voices.find(v => v.lang.startsWith('tr') && 
                            v.name.toLowerCase().includes('male')) ||
                        // KadÄ±n olmayan herhangi bir TÃ¼rkÃ§e ses
                        voices.find(v => v.lang.startsWith('tr') && 
                            !v.name.toLowerCase().includes('female') &&
                            !v.name.toLowerCase().includes('kadÄ±n') &&
                            !v.name.toLowerCase().includes('ayÅŸe') &&
                            !v.name.toLowerCase().includes('zeynep')) ||
                        // Son Ã§are: herhangi bir TÃ¼rkÃ§e ses
                        voices.find(v => v.lang.startsWith('tr'));

                    if (turkishVoice) {
                        speech.voice = turkishVoice;
                        console.log('ğŸ™ï¸ SeÃ§ilen ses:', turkishVoice.name, '| Dil:', turkishVoice.lang);
                    } else {
                        console.warn('âš ï¸ TÃ¼rkÃ§e ses bulunamadÄ±, varsayÄ±lan kullanÄ±lÄ±yor');
                    }

                    speech.lang = 'tr-TR';
                    
                    // AKICI KONUÅMA PARAMETRELERÄ°
                    speech.rate = 1.15;  // 1.3'ten 1.15'e dÃ¼ÅŸÃ¼rdÃ¼m - daha doÄŸal
                    speech.pitch = 1.0;  // 0.9'dan 1.0'a - daha net
                    speech.volume = 1.0;
                    
                    this.currentSpeech = speech;

                    const wordsPerSecond = speech.rate * 2.2; // 2.5'ten 2.2'ye - daha rahat
                    const baseMsPerWord = 1000 / wordsPerSecond;

                    // Diyalog balonlarÄ±nÄ± ses ile senkronize et (paragraf bazlÄ±)
                    this.clearDialogHighlights();
                    const bubbles = Array.from(document.querySelectorAll('.dialog-bubble'));
                    const durations = dialogues.map(d => {
                        const words = Math.max(1, d.text.split(' ').filter(Boolean).length);
                        return Math.max(1200, words * baseMsPerWord * 1.1);
                    });

                    let cumulative = 0;
                    durations.forEach((duration, index) => {
                        const startAt = cumulative;
                        cumulative += duration;
                        const timer = setTimeout(() => {
                            bubbles.forEach(b => b.classList.remove('active'));
                            const target = bubbles[index];
                            if (target) {
                                target.classList.add('active');
                                target.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }
                        }, startAt);
                        this.dialogHighlightTimers.push(timer);
                    });

                    // Seslendirme bitince
                    speech.onend = () => {
                        this.clearDialogHighlights();

                        this.currentSpeech = null;
                        this.updateReplayButtonState();

                        // MÃ¼ziÄŸi normale getir
                        if (this.musicNodes.length > 0) {
                            this.musicNodes.forEach(node => {
                                node.gainNode.gain.linearRampToValueAtTime(0.08, this.audioContext.currentTime + 0.8);
                            });
                        }
                        
                        this.playSound('complete');
                        if (onComplete) {
                            setTimeout(onComplete, 260);
                        }
                    };

                    // Hata durumunda
                    speech.onerror = (event) => {
                        console.error('Seslendirme hatasÄ±:', event);
                        this.clearDialogHighlights();
                        storyTextElement.innerHTML = this.highlightMathTerms(speechText);
                        this.currentSpeech = null;
                        this.updateReplayButtonState();
                        
                        // MÃ¼ziÄŸi normale getir
                        if (this.musicNodes.length > 0) {
                            this.musicNodes.forEach(node => {
                                node.gainNode.gain.linearRampToValueAtTime(0.08, this.audioContext.currentTime + 0.5);
                            });
                        }
                        
                        if (onComplete) {
                            setTimeout(onComplete, 500);
                        }
                    };

                    // Kelime sÄ±nÄ±rlarÄ±nÄ± dinle (destekleyen tarayÄ±cÄ±larda)
                    let wordBoundaryIndex = 0;
                    speech.onboundary = (event) => {
                        if (event.name === 'word') {
                            // GerÃ§ek kelime senkronizasyonu
                            wordBoundaryIndex++;
                        }
                    };

                    // Seslendirmeyi baÅŸlat
                    window.speechSynthesis.speak(speech);

                    // MÃ¼ziÄŸi kÄ±s - daha yumuÅŸak
                    if (this.musicNodes.length > 0) {
                        this.musicNodes.forEach(node => {
                            node.gainNode.gain.linearRampToValueAtTime(0.03, this.audioContext.currentTime + 0.5);
                        });
                    }
                });
            }

            replayStory() {
                if (!this.settings.speech || !this.currentStory) return;
                this.narrateStory(this.currentStory, () => {
                    document.getElementById('questionCard').style.display = 'block';
                });
            }

            updateProgress() {
                const level = gameData.levels[this.currentLevel];
                const progress = ((this.currentQuestion) / level.questions.length) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
            }

            checkAnswer(answerIndex) {
                const question = this.currentQuestions[this.currentQuestion]; // HAVUZDAN ALINAN SORU
                const buttons = document.querySelectorAll('.answer-btn');
                const questionCard = document.getElementById('questionCard');

                buttons.forEach(btn => btn.disabled = true);

                const isCorrect = answerIndex === question.correct;
                this.renderExplanation(question, isCorrect);

                if (isCorrect) {
                    buttons[answerIndex].classList.add('correct');
                    this.correctAnswers++;
                    this.playSound('correct');

                    setTimeout(() => {
                        this.nextQuestion();
                    }, 1000);
                } else {
                    buttons[answerIndex].classList.add('wrong');
                    buttons[question.correct].classList.add('correct');
                    this.wrongAnswers++;
                    this.playSound('wrong');

                    // 2 YANLIÅ - YumuÅŸak uyarÄ± ve ipucu
                    if (this.wrongAnswers === 2) {
                        this.hintAvailable = true;
                        this.triggerShake(questionCard);
                        this.updateHintBar(true);
                    }

                    // 3 YANLIÅ KONTROLÃœ
                    if (this.wrongAnswers >= 3) {
                        console.log('âŒ 3 yanlÄ±ÅŸ yapÄ±ldÄ±! Seviye baÅŸarÄ±sÄ±z.');
                        setTimeout(() => {
                            this.showGentleFailure();
                        }, 1400);
                    } else {
                        setTimeout(() => {
                            this.nextQuestion();
                        }, 2000);
                    }
                }
            }

            triggerShake(target) {
                if (!target) return;
                target.classList.add('shake');
                setTimeout(() => target.classList.remove('shake'), 800);
            }

            updateHintBar(forceShow = false) {
                const hintBar = document.getElementById('hintBar');
                const shouldShow = (this.hintAvailable || forceShow) && this.wrongAnswers >= 2;
                hintBar.hidden = !shouldShow;
                const hintButton = hintBar.querySelector('.hint-btn');
                if (hintButton) {
                    hintButton.disabled = this.hintUsedThisQuestion;
                }
            }

            requestHint() {
                if (!this.hintAvailable || this.hintUsedThisQuestion) return;

                const question = this.currentQuestions[this.currentQuestion];
                const buttons = Array.from(document.querySelectorAll('.answer-btn'));
                const candidates = buttons.filter((_, idx) => idx !== question.correct && !buttons[idx].disabled);

                if (candidates.length === 0) return;

                const chosen = candidates[Math.floor(Math.random() * candidates.length)];
                chosen.disabled = true;
                chosen.classList.add('disabled-hint');
                this.hintUsedThisQuestion = true;
                this.updateHintBar();
            }

            showGentleFailure() {
                this.stopActiveLoops();

                const modal = document.createElement('div');
                modal.id = 'failModal';
                modal.className = 'failure-modal soft';

                const level = gameData.levels[this.currentLevel];

                modal.innerHTML = `
                    <div class="failure-modal-overlay"></div>
                    <div class="gentle-failure" role="dialog" aria-modal="true" aria-labelledby="failureTitle" aria-describedby="failureDescription">
                        <div class="gentle-icon">ğŸ¤—</div>
                        <h2 class="gentle-title" id="failureTitle">Tekrar Deneyelim!</h2>
                        <p class="gentle-text" id="failureDescription">${level.title} macerasÄ± bitmedi! Daha sakin bir denemeyle baÅŸarabilirsin.</p>
                        <div class="gentle-actions">
                            <button class="btn btn-success" onclick="game.retryLevelWithHint()">ğŸ’¡ Ä°puÃ§lu Yeniden Dene</button>
                            <button class="btn btn-primary" onclick="game.exitToLevelSelect()">ğŸ“‹ Seviye SeÃ§imi</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                this.playSound('wrong');
            }

            retryLevelFromModal() {
                // Modal'Ä± kaldÄ±r
                const modal = document.getElementById('failModal');
                if (modal) {
                    modal.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => modal.remove(), 300);
                }

                // Ses efekti
                this.playSound('click');

                // Seviyeyi yeni sorularla yeniden baÅŸlat
                console.log('ğŸ”„ BÃ¶lÃ¼m havuzdan yeni sorularla yeniden baÅŸlatÄ±lÄ±yor...');
                setTimeout(() => {
                    this.retryLevel();
                }, 500);
            }

            retryLevelWithHint() {
                const modal = document.getElementById('failModal');
                if (modal) {
                    modal.style.animation = 'fadeOut 0.25s ease';
                    setTimeout(() => modal.remove(), 250);
                }

                this.playSound('click');
                this.hintAvailable = true;
                setTimeout(() => this.retryLevel(), 300);
            }

            exitToLevelSelect() {
                // Modal'Ä± kaldÄ±r
                const modal = document.getElementById('failModal');
                if (modal) {
                    modal.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => modal.remove(), 300);
                }

                // Ses efekti
                this.playSound('click');

                // Seviye seÃ§imine dÃ¶n
                setTimeout(() => {
                    this.showLevelSelect();
                }, 500);
            }

            retryLevel() {
                // Seviyeyi sÄ±fÄ±rla ve havuzdan YENÄ° sorular seÃ§
                console.log('ğŸ”„ Seviye yeniden baÅŸlatÄ±lÄ±yor...');
                this.startLevel(this.currentLevel);
            }

            nextQuestion() {
                if (this.currentQuestion < this.currentQuestions.length - 1) {
                    this.currentQuestion++;
                    this.showStoryAndQuestion();
                } else {
                    this.completeLevel();
                }
            }

            startTimer() {
                if (this.timer) {
                    clearInterval(this.timer);
                }

                this.updateTimerDisplay();

                this.timer = setInterval(() => {
                    this.timeRemaining--;
                    this.updateTimerDisplay();

                    if (this.timeRemaining <= 30) {
                        document.getElementById('timer').classList.add('warning');
                    }

                    if (this.timeRemaining <= 0) {
                        this.timeUp();
                    }
                }, 1000);
            }

            updateTimerDisplay() {
                const minutes = Math.floor(this.timeRemaining / 60);
                const seconds = this.timeRemaining % 60;
                document.getElementById('timer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            timeUp() {
                clearInterval(this.timer);
                this.completeLevel();
            }

            completeLevel() {
                clearInterval(this.timer);

                const level = gameData.levels[this.currentLevel];
                const timeBonus = Math.max(0, Math.floor(this.timeRemaining / 10));
                const badge = this.calculateBadge(level);

                this.completedLevels.add(this.currentLevel + 1);
                this.totalCorrect += this.correctAnswers;
                this.totalScore += this.correctAnswers * 10 + timeBonus;
                level.badge = badge;

                this.playSound('complete');

                document.getElementById('resultIcon').textContent =
                    this.correctAnswers >= 4 ? 'ğŸ‰' : this.correctAnswers >= 3 ? 'ğŸ‘' : 'ğŸ’ª';
                document.getElementById('resultTitle').textContent = 
                    this.correctAnswers >= 4 ? 'MÃ¼kemmel!' : 
                    this.correctAnswers >= 3 ? 'Ä°yi Ä°ÅŸ!' : 'Devam Et!';
                document.getElementById('resultMessage').textContent = 
                    this.correctAnswers >= 4 ? 'Seviyeyi harika tamamladÄ±n! Matematik kahramanÄ±sÄ±n!' :
                    this.correctAnswers >= 3 ? 'GÃ¼zel bir performans! Bir sonraki seviyeye hazÄ±r mÄ±sÄ±n?' :
                    'Pratik yapmaya devam et, baÅŸarÄ±lÄ± olacaksÄ±n!';
                
                document.getElementById('correctAnswers').textContent = this.correctAnswers;
                document.getElementById('wrongAnswers').textContent = this.wrongAnswers;
                document.getElementById('timeBonus').textContent = '+' + timeBonus;

                const resultBadge = document.getElementById('resultBadge');
                if (badge) {
                    resultBadge.textContent = `${this.getBadgeIcon(badge)} ${badge}`;
                    resultBadge.classList.remove('hidden');
                } else {
                    resultBadge.textContent = '';
                    resultBadge.classList.add('hidden');
                }

                const summaryItems = this.buildLearningSummary();
                this.renderLearningSummary(summaryItems);

                const bloomText = this.buildBloomSummaryText();
                this.renderBloomSummary(bloomText);

                this.showScreen('resultScreen');
            }

            nextLevel() {
                if (this.currentLevel < gameData.levels.length - 1) {
                    this.startLevel(this.currentLevel + 1);
                } else {
                    this.showFinal();
                }
            }

            showFinal() {
                document.getElementById('finalScore').textContent = this.totalScore;
                document.getElementById('finalCorrect').textContent = this.totalCorrect + '/35';
                const summary = document.getElementById('finalThemeSummary');
                if (summary) {
                    summary.innerHTML = gameData.levels.map((level) => {
                        const theme = this.getLevelTheme(level.id);
                        const icon = theme?.icon || 'â­';
                        const label = theme?.name || level.title;
                        return `<div class="final-theme-row">${icon} Seviye ${level.id}: ${label}</div>`;
                    }).join('');
                }
                this.showScreen('finalScreen');
            }

            restart() {
                this.currentLevel = 0;
                this.completedLevels.clear();
                this.totalScore = 0;
                this.totalCorrect = 0;
                this.showWelcome();
            }
        }

        // Oyunu baÅŸlat
        const game = new Game();

        // Teknik Not: YÄ±ldÄ±z ve parÃ§acÄ±k sayÄ±larÄ± azaltÄ±ldÄ±, mobilde otomatik %50 dÃ¼ÅŸÃ¼rme eklendi,
        // tek bir requestAnimationFrame dÃ¶ngÃ¼sÃ¼ yÄ±ldÄ±z parlamalarÄ±nÄ± yÃ¶netiyor.
        // Hafif Mod, kutu gÃ¶lgelerini sadeleÅŸtirip aÄŸÄ±r arka plan animasyonlarÄ±nÄ± kapatÄ±yor.

        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById('introToggle');
            const panel = document.getElementById('longIntro');

            if (toggle && panel) {
                toggle.addEventListener('click', () => {
                    const expanded = toggle.getAttribute('aria-expanded') === 'true';
                    const nextState = !expanded;
                    toggle.setAttribute('aria-expanded', nextState.toString());
                    panel.hidden = !nextState;
                    toggle.textContent = nextState ? 'Daha az gÃ¶ster â–²' : 'Daha fazlasÄ±nÄ± oku â–¼';
                });
            }
        });
    </script>
</body>
</html>